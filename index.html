<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wealth Calculator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000000;
            min-height: 100vh;
            padding: 24px 16px;
        }

        .container {
            max-width: 820px;
            margin: 0 auto;
            background: #0a0a0a;
            border-radius: 28px;
            padding: 48px 40px;
            box-shadow: 0 24px 80px rgba(190, 242, 2, 0.08);
            border: 1px solid #1a1a1a;
        }

        h1 {
            color: #ffffff;
            margin-bottom: 44px;
            font-size: 34px;
            font-weight: 800;
            letter-spacing: -0.8px;
        }

        .input-group { margin-bottom: 26px; }

        label {
            display: block;
            color: #a0a0a0;
            font-weight: 500;
            margin-bottom: 10px;
            font-size: 14px;
            letter-spacing: 0.3px;
        }

        input[type="number"],
        input[type="text"] {
            width: 100%;
            padding: 18px 20px;
            border: 2px solid #1a1a1a;
            border-radius: 14px;
            font-size: 16px;
            transition: all 0.3s;
            background: #0f0f0f;
            color: #ffffff;
        }

        input[type="number"]:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #bef202;
            background: #0a0a0a;
            box-shadow: 0 0 0 4px rgba(190, 242, 2, 0.08);
        }

        input::placeholder { color: #404040; }

        /* ‚îÄ‚îÄ RESULT CARD ‚îÄ‚îÄ */
        .result-box {
            background: linear-gradient(145deg, #bef202 0%, #9ecc00 100%);
            color: #000000;
            padding: 44px 40px;
            border-radius: 28px;
            margin: 44px 0;
            text-align: center;
            box-shadow: 0 16px 60px rgba(190, 242, 2, 0.25);
            animation: fadeSlideUp 0.5s ease both;
        }

        @keyframes fadeSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .result-box h2 {
            font-size: 13px;
            margin-bottom: 10px;
            opacity: 0.65;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .result-box .amount {
            font-size: 52px;
            font-weight: 900;
            margin: 14px 0 6px;
            letter-spacing: -1.5px;
            line-height: 1;
        }

        .result-box .years-label {
            font-size: 15px;
            opacity: 0.6;
            font-weight: 500;
            margin-bottom: 36px;
        }

        /* ‚îÄ‚îÄ INCOME SECTION ‚îÄ‚îÄ */
        .income-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 22px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .income-title {
            font-size: 12px;
            opacity: 0.7;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            font-weight: 700;
        }

        .toggle-buttons {
            display: flex;
            gap: 4px;
            background: rgba(0,0,0,0.15);
            padding: 4px;
            border-radius: 10px;
        }

        .toggle-btn {
            padding: 8px 18px;
            border: none;
            background: transparent;
            color: rgba(0,0,0,0.5);
            font-size: 13px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            font-weight: 600;
        }

        .toggle-btn.active {
            background: #000000;
            color: #bef202;
        }

        /* ‚îÄ‚îÄ INCOME CARDS ‚îÄ‚îÄ */
        .income-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            text-align: left;
        }

        .income-card {
            padding: 22px 20px;
            border-radius: 18px;
            background: rgba(0,0,0,0.55);
            border: 1px solid rgba(255,255,255,0.06);
            backdrop-filter: blur(10px);
            transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
            cursor: default;
        }

        .income-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 14px 36px rgba(0,0,0,0.55);
            border-color: rgba(190,242,2,0.35);
        }

        .income-card .card-label {
            font-size: 11px;
            opacity: 0.5;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 12px;
            color: #ffffff;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .income-card .card-value {
            font-size: 22px;
            font-weight: 800;
            color: #ffffff;
            letter-spacing: -0.5px;
            line-height: 1.2;
        }

        /* ‚îÄ‚îÄ CUSTOM ROI ‚îÄ‚îÄ */
        .custom-roi-row {
            margin-top: 26px;
            padding-top: 22px;
            border-top: 1px solid rgba(0,0,0,0.25);
        }

        .custom-roi-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            cursor: pointer;
            margin-bottom: 14px;
            color: rgba(0,0,0,0.7);
            font-weight: 700;
        }

        .custom-roi-label input[type="checkbox"] {
            width: 18px; height: 18px;
            accent-color: #000;
            cursor: pointer;
        }

        .custom-roi-input-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .custom-roi-input-row input[type="number"] {
            width: 90px;
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,0.3);
            background: rgba(0,0,0,0.2);
            color: #000;
            font-size: 15px;
            font-weight: 700;
        }

        .custom-roi-input-row input[type="number"]:focus {
            outline: none;
            border-color: rgba(0,0,0,0.5);
            box-shadow: none;
        }

        .custom-roi-pct   { font-size: 15px; color: rgba(0,0,0,0.6); font-weight: 600; }
        .custom-roi-value { font-size: 20px; font-weight: 800; color: #000; margin-left: 8px; }

        /* ‚îÄ‚îÄ CHART ‚îÄ‚îÄ */
        .chart-container {
            margin: 40px 0;
            position: relative;
            height: 440px;
            background: #0d0d0d;
            border-radius: 24px;
            padding: 28px 24px 20px;
            border: 1px solid #1e1e1e;
            animation: fadeSlideUp 0.5s ease 0.15s both;
        }

        /* ‚îÄ‚îÄ FIRE SECTION ‚îÄ‚îÄ */
        .fire-section {
            border-top: 1px solid #1a1a1a;
            padding-top: 44px;
            margin-top: 44px;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 28px;
        }

        .checkbox-container input[type="checkbox"] {
            width: 26px; height: 26px;
            margin-right: 14px;
            cursor: pointer;
            accent-color: #bef202;
        }

        .checkbox-container label {
            margin: 0;
            cursor: pointer;
            font-size: 20px;
            color: #ffffff;
            font-weight: 700;
        }

        .fire-inputs {
            background: #0f0f0f;
            padding: 36px;
            border-radius: 24px;
            margin-top: 24px;
            border: 1px solid #1a1a1a;
        }

        .fire-result {
            background: #0f0f0f;
            border: 2px solid #bef202;
            padding: 36px;
            border-radius: 24px;
            margin-top: 28px;
            animation: fadeSlideUp 0.4s ease both;
        }

        .fire-result h3 { color: #bef202; margin-bottom: 14px; font-size: 22px; font-weight: 700; }
        .fire-result p  { color: #d0d0d0; line-height: 1.9; font-size: 15px; }

        .fire-year {
            font-size: 56px;
            font-weight: 900;
            color: #bef202;
            margin: 16px 0;
            letter-spacing: -2px;
        }


        .fire-preview .toggle-btn {
            background: transparent;
            color: #555;
            border: none;
            padding: 7px 14px;
            font-size: 12px;
        }

        .fire-preview .toggle-btn.active {
            background: #bef202;
            color: #000;
            font-weight: 700;
        }

        /* fire-preview is dark, override toggle-btn defaults */
        #firePreview { background: #0a0a0a; border: 1px solid #2a2a2a; }

        /* ‚îÄ‚îÄ FIRE PREVIEW ‚îÄ‚îÄ */
        .fire-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 20px 24px;
            margin-bottom: 24px;
            text-align: center;
            gap: 6px;
        }

        .fire-preview-label {
            font-size: 11px;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 700;
        }

        .fire-preview-value {
            font-size: 32px;
            font-weight: 900;
            color: #bef202;
            letter-spacing: -1px;
        }

        .fire-preview-sub {
            font-size: 12px;
            color: #444;
        }

        /* ‚îÄ‚îÄ FIRE NOT REACHED ‚Äî SWIPE CARDS ‚îÄ‚îÄ */
        .fire-not-reached-header {
            text-align: center;
            margin-bottom: 28px;
        }

        .fire-not-reached-header h3 {
            color: #ff5f5f;
            font-size: 22px;
            font-weight: 800;
            margin-bottom: 10px;
        }

        .fire-not-reached-header p {
            color: #888;
            font-size: 14px;
            line-height: 1.8;
        }

        .fire-stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin: 20px 0 22px;
            text-align: left;
        }

        .fire-stat-card {
            background: #111;
            border: 1px solid #1e1e1e;
            border-radius: 16px;
            padding: 16px 14px;
            transition: transform 0.2s ease, border-color 0.2s ease;
        }

        .fire-stat-card:hover {
            transform: translateY(-3px);
            border-color: #2a2a2a;
        }

        .fire-stat-label {
            font-size: 10px;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .fire-stat-value {
            font-size: 16px;
            font-weight: 800;
            color: #fff;
        }

        .fire-stat-sub {
            font-size: 10px;
            color: #444;
            margin-top: 4px;
        }

        .swipe-hint {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: #bef202;
            font-size: 13px;
            font-weight: 600;
            margin: 18px 0 24px;
            letter-spacing: 0.5px;
            animation: blink 2s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50%       { opacity: 0.45; }
        }

        .swipe-arrow { font-size: 16px; }

        /* Scroll carousel */
        .suggestions-carousel {
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            display: flex;
            gap: 14px;
            padding-bottom: 4px;
            scrollbar-width: none;
        }

        .suggestions-carousel::-webkit-scrollbar { display: none; }

        .suggestion-card {
            flex: 0 0 82%;
            scroll-snap-align: start;
            background: #141414;
            border: 1px solid #2a2a2a;
            border-radius: 20px;
            padding: 28px 24px;
            transition: border-color 0.3s;
        }

        .suggestion-card:hover { border-color: #bef202; }

        .suggestion-card .s-number {
            font-size: 11px;
            color: #444;
            font-weight: 700;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .suggestion-card .s-title {
            font-size: 15px;
            font-weight: 600;
            color: #888;
            margin-bottom: 18px;
            line-height: 1.5;
        }

        .suggestion-card .s-value {
            font-size: 36px;
            font-weight: 900;
            color: #bef202;
            letter-spacing: -1px;
            line-height: 1;
        }

        .suggestion-card .s-sub {
            font-size: 13px;
            color: #444;
            margin-top: 12px;
            line-height: 1.65;
        }

        /* Carousel dots */
        .carousel-dots {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-top: 18px;
        }

        .carousel-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: #2a2a2a;
            transition: background 0.25s, width 0.25s;
        }

        .carousel-dot.active {
            background: #bef202;
            width: 20px;
            border-radius: 3px;
        }

        /* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
        .hidden { display: none; }

        small { color: #555; font-size: 12px; }

        .info-icon {
            display: inline-block;
            width: 18px; height: 18px;
            background: #1a1a1a;
            color: #bef202;
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 11px;
            font-weight: bold;
            cursor: help;
            margin-left: 6px;
            position: relative;
            border: 1px solid #2a2a2a;
        }

        .info-icon:hover .tooltip,
        .info-icon:active .tooltip { display: block; }

        .tooltip {
            display: none;
            position: absolute;
            bottom: 26px;
            left: 50%;
            transform: translateX(-50%);
            background: #1a1a1a;
            color: #ffffff;
            padding: 12px 14px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 400;
            z-index: 1000;
            box-shadow: 0 8px 24px rgba(0,0,0,0.6);
            width: max-content;
            max-width: min(240px, calc(100vw - 40px));
            white-space: normal;
            border: 1px solid #2a2a2a;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%; left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #1a1a1a;
        }

        .calc-btn {
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, #bef202 0%, #a0d000 100%);
            color: #000000;
            border: none;
            border-radius: 16px;
            font-size: 17px;
            font-weight: 800;
            cursor: pointer;
            margin-top: 18px;
            box-shadow: 0 8px 28px rgba(190, 242, 2, 0.28);
            transition: all 0.25s;
            letter-spacing: 0.3px;
        }

        .calc-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 14px 36px rgba(190, 242, 2, 0.38);
        }

        .calc-btn:active { transform: translateY(0); }

        /* ‚îÄ‚îÄ LOADER ‚îÄ‚îÄ */
        #loader {
            display: none;
            text-align: center;
            padding: 48px 0;
            margin: 24px 0;
        }

        .spinner {
            display: inline-block;
            width: 52px; height: 52px;
            border: 4px solid #1a1a1a;
            border-top: 4px solid #bef202;
            border-radius: 50%;
            animation: spin 0.9s linear infinite;
        }

        #loaderText {
            margin-top: 20px;
            font-size: 15px;
            color: #bef202;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        @keyframes spin {
            0%   { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ‚îÄ‚îÄ INFLATION TOGGLE ‚îÄ‚îÄ */
        .inflation-toggle {
            display: none;
            margin: 28px 0;
        }

        .inflation-toggle label {
            display: flex;
            align-items: center;
            font-size: 14px;
            cursor: pointer;
            padding: 18px 20px;
            background: #0f0f0f;
            border-radius: 14px;
            border: 1px solid #1a1a1a;
            transition: border-color 0.2s;
        }

        .inflation-toggle label:hover { border-color: #2a2a2a; }

        .inflation-toggle input[type="checkbox"] {
            margin-right: 12px;
            width: 20px; height: 20px;
            cursor: pointer;
            accent-color: #bef202;
        }

        .inflation-label-text { font-weight: 600; color: #ffffff; }

        /* ‚îÄ‚îÄ FIRE INFO BOX ‚îÄ‚îÄ */
        .fire-info-box {
            border: 1px solid #1a1a1a;
            border-left: 3px solid #bef202;
            padding: 22px;
            border-radius: 14px;
            margin-bottom: 28px;
            display: flex;
            gap: 14px;
            align-items: flex-start;
            background: #0a0a0a;
        }

        .fire-info-box .emoji { font-size: 28px; flex-shrink: 0; }
        .fire-info-box strong { color: #bef202; font-size: 15px; font-weight: 700; letter-spacing: 0.5px; }
        .fire-info-box p { margin: 8px 0 0; font-size: 13px; color: #909090; line-height: 1.7; white-space: normal; word-break: break-word; overflow-wrap: break-word; }

        /* ‚îÄ‚îÄ PASSIVE INFO BOX (inside yellow card) ‚îÄ‚îÄ */
        .passive-info-box {
            border-radius: 16px;
            padding: 20px 22px;
            margin-bottom: 22px;
            display: flex;
            gap: 14px;
            align-items: flex-start;
            background: rgba(0,0,0,0.62);
            border: 1px solid rgba(0,0,0,0.2);
            border-left: 4px solid #000000;
            text-align: left;
        }

        .passive-info-box .emoji { font-size: 24px; flex-shrink: 0; padding-top: 2px; }
        .passive-info-box strong { color: #bef202; font-size: 14px; font-weight: 700; display: block; margin-bottom: 4px; }
        .passive-info-box p { font-size: 12px; color: rgba(255,255,255,0.65); line-height: 1.7; margin: 0; white-space: normal; word-break: break-word; overflow-wrap: break-word; }

        /* ‚îÄ‚îÄ FEATURED INCOME CARD ‚îÄ‚îÄ */
        .income-card-featured {
            background: rgba(0,0,0,0.65) !important;
            border-color: rgba(190,242,2,0.25) !important;
            padding: 24px 22px !important;
            margin-bottom: 12px;
        }

        .income-card-featured .card-label { opacity: 0.7 !important; font-size: 12px !important; }
        .income-card-featured .card-value { font-size: 28px !important; color: #bef202 !important; }

        .income-card-custom {
            background: rgba(0,0,0,0.4) !important;
            border-color: rgba(190,242,2,0.2) !important;
            margin-top: 0 !important;
        }

        /* ‚îÄ‚îÄ FIRE STAT STACK (replaces cluttered 3-col grid) ‚îÄ‚îÄ */
        .fire-stat-stack {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0 24px;
        }

        .fire-stat-row-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 20px;
            background: #111;
            border: 1px solid #1e1e1e;
            border-radius: 16px;
            gap: 16px;
            transition: transform 0.2s ease, border-color 0.2s ease;
        }

        .fire-stat-row-card:hover {
            transform: translateX(4px);
            border-color: #2a2a2a;
        }

        .fsr-danger { border-left: 3px solid transparent; }
        .fire-stat-row-card:hover { border-left: 3px solid #ff5f5f !important; border-color: #ff5f5f; }

        .fsr-left { flex: 1; text-align: left; }

        .fsr-label {
            font-size: 13px;
            font-weight: 700;
            color: #ccc;
            margin-bottom: 4px;
        }

        .fsr-sub {
            font-size: 11px;
            color: #555;
            font-weight: 500;
        }

        .fsr-value {
            font-size: 18px;
            font-weight: 900;
            color: #fff;
            letter-spacing: -0.5px;
            white-space: nowrap;
            text-align: right;
        }

        @media (max-width: 480px) {
            .fire-stat-row-card { flex-direction: column; align-items: flex-start; gap: 8px; }
            .fsr-value { font-size: 20px; }
        }


        /* ‚îÄ‚îÄ BREAKDOWN GRID ‚îÄ‚îÄ */
        .breakdown-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            text-align: left;
        }

        .bk-card {
            background: rgba(0,0,0,0.35);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 16px;
            padding: 18px 14px;
            cursor: pointer;
            transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
            position: relative;
        }

        .bk-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(0,0,0,0.5);
            border-color: rgba(190,242,2,0.4);
        }

        .bk-icon {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .bk-label {
            font-size: 10px;
            opacity: 0.5;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #fff;
        }

        .bk-value {
            font-size: 16px;
            font-weight: 800;
            color: #fff;
            letter-spacing: -0.3px;
        }

        .bk-profit { color: #bef202; }

        .bk-tap {
            font-size: 9px;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-top: 8px;
            font-weight: 600;
        }

        .bk-card:hover .bk-tap { color: rgba(190,242,2,0.5); }

        @media (max-width: 600px) {
            .breakdown-grid { gap: 8px; }
            .bk-card { padding: 14px 10px; }
            .bk-value { font-size: 13px; }
        }


        /* ‚îÄ‚îÄ TOAST NOTIFICATION ‚îÄ‚îÄ */
        #toastBar {
            position: fixed;
            top: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(-80px);
            background: #111;
            border: 1px solid #ff5f5f;
            border-left: 4px solid #ff5f5f;
            color: #fff;
            padding: 14px 22px;
            border-radius: 14px;
            font-size: 13px;
            font-weight: 600;
            z-index: 9999;
            box-shadow: 0 12px 40px rgba(0,0,0,0.7);
            transition: transform 0.35s cubic-bezier(0.34,1.56,0.64,1), opacity 0.35s ease;
            opacity: 0;
            white-space: normal;
            word-break: break-word;
            max-width: calc(100vw - 32px);
            width: max-content;
            text-align: center;
            line-height: 1.5;
        }

        #toastBar.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* ‚îÄ‚îÄ INPUT ERROR STATE ‚îÄ‚îÄ */
        input.input-error {
            border-color: #ff5f5f !important;
            box-shadow: 0 0 0 4px rgba(255,95,95,0.12) !important;
            animation: shakeInput 0.35s ease;
        }

        @keyframes shakeInput {
            0%,100% { transform: translateX(0); }
            20%      { transform: translateX(-6px); }
            60%      { transform: translateX(6px); }
        }

        /* ‚îÄ‚îÄ SIP STOP MODE BUTTONS ‚îÄ‚îÄ */
        .sip-stop-mode-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 9px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sip-stop-mode-btn.active {
            background: #bef202;
            color: #000;
        }

        .sip-stop-mode-btn:not(.active) {
            background: transparent;
            color: #555;
        }

        /* ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ */
        @media (max-width: 600px) {
            .container { padding: 32px 20px; }
            h1 { font-size: 26px; margin-bottom: 48px; padding-right: 0; padding-left: 0; }
            h1 button { position: static !important; transform: none !important; display: block; margin: 12px auto 0; font-size: 12px; padding: 8px 16px; }
            .result-box { padding: 36px 22px; }
            .result-box .amount { font-size: 40px; }
            .income-grid { gap: 10px; }
            .income-card { padding: 18px 14px; }
            .income-card .card-value { font-size: 18px; }
            .chart-container { height: 320px; padding: 18px 12px 14px; }
            .fire-inputs { padding: 24px 18px; }
            .fire-year { font-size: 44px; }
            .suggestion-card { flex: 0 0 92%; }
            .suggestion-card .s-value { font-size: 28px; }
            .sip-modal-box { padding: 24px 16px; margin: 12px; border-radius: 20px; }
            .info-icon .tooltip { left: auto; right: 0; transform: none; max-width: 220px; }
            .info-icon .tooltip::after { left: auto; right: 12px; transform: none; }
            .fire-info-box p, .passive-info-box p { white-space: normal; word-break: break-word; overflow-wrap: break-word; }
        }


        /* breakdownModal uses style.display=flex directly */

        /* ‚îÄ‚îÄ SIP MODAL ‚îÄ‚îÄ */
        .sip-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(4px);
        }

        .sip-modal-overlay.open { display: flex; }

        .sip-modal-box {
            background: #0a0a0a;
            border: 1px solid #1e1e1e;
            border-radius: 24px;
            padding: 32px;
            width: 100%;
            max-width: 580px;
            max-height: 88vh;
            display: flex;
            flex-direction: column;
            gap: 20px;
            animation: fadeSlideUp 0.3s ease both;
        }

        .sip-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
        }

        .sip-modal-header h2 {
            font-size: 20px;
            font-weight: 800;
            color: #fff;
            letter-spacing: -0.4px;
        }

        .sip-modal-close {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            color: #888;
            width: 36px; height: 36px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .sip-modal-close:hover { background: #222; color: #fff; }

        .sip-modal-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
        }

        .sip-cal-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #888;
            cursor: pointer;
        }

        .sip-cal-toggle input { width:16px; height:16px; accent-color:#bef202; cursor:pointer; }

        .sip-save-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #bef202, #a0d000);
            color: #000;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sip-save-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(190,242,2,0.3); }

        .sip-table-wrap {
            overflow-y: auto;
            border-radius: 14px;
            border: 1px solid #1a1a1a;
            flex: 1;
        }

        .sip-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .sip-table thead th {
            background: #111;
            color: #666;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            padding: 14px 16px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 2;
        }

        .sip-table tbody tr { border-top: 1px solid #141414; }
        .sip-table tbody tr:hover { background: #0f0f0f; }

        .sip-table td {
            padding: 12px 16px;
            color: #ccc;
            vertical-align: middle;
        }

        .sip-table td.year-col { color: #555; font-size: 13px; font-weight: 600; }
        .sip-table td.current-year { color: #bef202; font-weight: 700; }

        .sip-cell-input {
            background: transparent;
            border: none;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            padding: 4px 0;
            outline: none;
            border-bottom: 1px solid transparent;
            transition: border-color 0.2s;
        }

        .sip-cell-input:focus { border-bottom-color: #bef202; }

        .sip-edited-badge {
            display: inline-block;
            font-size: 10px;
            color: #bef202;
            background: rgba(190,242,2,0.1);
            border-radius: 4px;
            padding: 1px 5px;
            margin-left: 6px;
            vertical-align: middle;
        }

        .sip-reset-btn {
            font-size: 11px;
            color: #555;
            background: none;
            border: none;
            cursor: pointer;
            text-decoration: underline;
            padding: 0;
        }

        .sip-reset-btn:hover { color: #bef202; }

        /* ‚îÄ‚îÄ SIP CELL EDIT POPUP ‚îÄ‚îÄ */
        .sip-edit-popup-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.75);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(6px);
        }

        .sip-edit-popup-overlay.open { display: flex; }

        .sip-edit-popup {
            background: #0d0d0d;
            border: 1px solid #2a2a2a;
            border-radius: 24px;
            padding: 32px 28px;
            width: 90%;
            max-width: 360px;
            animation: fadeSlideUp 0.25s ease both;
        }

        .sip-edit-popup h3 {
            font-size: 16px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 8px;
        }

        .sip-edit-popup .pop-year {
            font-size: 12px;
            color: #555;
            margin-bottom: 24px;
        }

        .sip-edit-popup .pop-input {
            width: 100%;
            padding: 18px 20px;
            background: #0f0f0f;
            border: 2px solid #2a2a2a;
            border-radius: 14px;
            font-size: 20px;
            font-weight: 700;
            color: #fff;
            outline: none;
            transition: border-color 0.2s;
            margin-bottom: 10px;
        }

        .sip-edit-popup .pop-input:focus { border-color: #bef202; }

        .sip-edit-popup .pop-preview {
            font-size: 28px;
            font-weight: 900;
            color: #bef202;
            letter-spacing: -1px;
            min-height: 36px;
            margin-bottom: 6px;
        }

        .sip-edit-popup .pop-yearly {
            font-size: 13px;
            color: #555;
            margin-bottom: 28px;
        }

        .sip-edit-popup-btns {
            display: flex;
            gap: 10px;
        }

        .pop-cancel {
            flex: 1;
            padding: 14px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            color: #888;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pop-cancel:hover { color: #fff; }

        .pop-confirm {
            flex: 1;
            padding: 14px;
            background: linear-gradient(135deg, #bef202, #a0d000);
            border: none;
            border-radius: 12px;
            color: #000;
            font-size: 14px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pop-confirm:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(190,242,2,0.3); }
    </style>
</head>
<body>
<div class="container">
    <h1 style="position:relative;text-align:center;margin-bottom:44px;font-size:34px;font-weight:800;letter-spacing:-0.8px;color:#ffffff;padding-right:110px;padding-left:110px;">
        Wealth Calculator
        <button onclick="clearAll()" style="position:absolute;top:50%;right:0;transform:translateY(-50%);background:#1a1a1a;border:1px solid #2a2a2a;color:#666;padding:8px 14px;border-radius:12px;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s;letter-spacing:0.3px;white-space:nowrap;" onmouseover="this.style.borderColor='#bef202';this.style.color='#bef202'" onmouseout="this.style.borderColor='#2a2a2a';this.style.color='#666'">‚úï Clear All</button>
    </h1>

    <div class="input-group">
        <label>Initial Investment (PKR)
            <span class="info-icon">i<span class="tooltip">One-time lump sum amount you're investing today</span></span>
        </label>
        <!-- FIX 2: placeholder 100,000 | FIX 3: inputmode="numeric" for numeric keyboard -->
        <input type="text" id="initialInvestment" placeholder="100,000"
               inputmode="numeric" oninput="formatNumberInput(this)">
    </div>

    <div class="input-group">
        <label>Monthly SIP (PKR) ‚Äî Optional
            <span class="info-icon">i<span class="tooltip">Systematic Investment Plan ‚Äì fixed monthly contribution</span></span>
        </label>
        <input type="text" id="sip" placeholder="5,000"
               inputmode="numeric" oninput="formatNumberInput(this)">
    </div>

    <div class="input-group">
        <label>Expected Annual Return (%)
            <span class="info-icon">i<span class="tooltip">Average yearly return rate you expect from your investments</span></span>
        </label>
        <input type="number" id="returnRate" placeholder="12" step="0.1" inputmode="decimal">
    </div>

    <div class="input-group">
        <label>Yearly SIP Increase (%) ‚Äî Optional
            <span class="info-icon">i<span class="tooltip">How much your monthly SIP grows each year (e.g. 10% mirrors a salary hike)</span></span>
        </label>
        <input type="number" id="sipYearlyChange" placeholder="10" step="0.1" inputmode="decimal">
    </div>

    <div class="input-group" id="sipStopGroup">
        <label>Stop Increasing SIP ‚Äî Optional
            <span class="info-icon">i<span class="tooltip">Choose when to freeze your SIP increases: after a set number of years, or once your monthly SIP hits a specific amount.</span></span>
        </label>
        <div style="display:flex;gap:0;background:#0f0f0f;border:2px solid #1a1a1a;border-radius:12px;padding:4px;margin-bottom:12px;">
            <button id="sipStopModeYear" onclick="setSipStopMode('year')" class="sip-stop-mode-btn active">
                After N Years
            </button>
            <button id="sipStopModeAmt" onclick="setSipStopMode('amount')" class="sip-stop-mode-btn">
                When SIP Reaches
            </button>
        </div>
        <div id="sipStopYearField">
            <input type="number" id="sipStopYear" placeholder="e.g. 10" inputmode="numeric" oninput="validateSipStopYear(this)">
            <small>SIP stops growing after this many years</small>
        </div>
        <div id="sipStopAmtField" style="display:none;">
            <input type="text" id="sipStopAmount" placeholder="e.g. 50,000" inputmode="numeric" oninput="formatNumberInput(this)">
            <small>SIP stops growing once it reaches this monthly amount</small>
        </div>
    </div>

    <div class="input-group" id="sipContribStopGroup">
        <label>Stop SIP Contributions ‚Äî Optional
            <span class="info-icon">i<span class="tooltip">Stop making monthly SIP contributions once your total amount contributed reaches a set figure, or after a set number of years. Leave blank to keep investing for the full period.</span></span>
        </label>
        <div style="display:flex;gap:0;background:#0f0f0f;border:2px solid #1a1a1a;border-radius:12px;padding:4px;margin-bottom:12px;">
            <button id="sipContribStopModeYear" onclick="setSipContribStopMode('year')" class="sip-stop-mode-btn active">After N Years</button>
            <button id="sipContribStopModeAmt"  onclick="setSipContribStopMode('amount')" class="sip-stop-mode-btn">When Total Contributed</button>
        </div>
        <div id="sipContribStopYearField">
            <input type="number" id="sipContribStopYear" placeholder="e.g. 15" inputmode="numeric"
                   oninput="validateSipContribStopYear(this)">
            <small>SIP contributions stop entirely after this many years. Leave blank to keep contributing till the end.</small>
        </div>
        <div id="sipContribStopAmtField" style="display:none;">
            <input type="text" id="sipContribStopAmount" placeholder="e.g. 50,00,000" inputmode="numeric" oninput="formatNumberInput(this)">
            <small>SIP contributions stop once your cumulative total contributed reaches this amount.</small>
        </div>
    </div>

    <div class="input-group">
        <label>Investment Period (Years)
            <span class="info-icon">i<span class="tooltip">Total number of years you plan to invest</span></span>
        </label>
        <input type="number" id="years" placeholder="20" inputmode="numeric">
    </div>

    <button class="calc-btn" onclick="calculateWealth()">üìä Calculate my Expected Wealth</button>

    <!-- SIP BREAKDOWN BUTTON (shown after calculation) -->
    <div id="sipBreakdownBtn" style="display:none; margin-top:16px;">
        <button onclick="openSipModal()"
            style="width:100%;padding:14px 20px;background:#0f0f0f;color:#bef202;border:1px solid #2a2a2a;border-radius:14px;font-size:15px;font-weight:600;cursor:pointer;transition:all 0.2s;letter-spacing:0.3px;"
            onmouseover="this.style.borderColor='#bef202'" onmouseout="this.style.borderColor='#2a2a2a'">
            ‚úèÔ∏è Make Your Own SIP Plan
        </button>
    </div>

    <!-- ZAKAT TOGGLE -->
    <div id="zakatToggleSection" style="display:none;margin-top:12px;">
        <label style="display:flex;align-items:center;gap:12px;cursor:pointer;padding:16px 20px;background:#0f0f0f;border-radius:14px;border:1px solid #1a1a1a;transition:border-color 0.2s;" onmouseover="this.style.borderColor='#2a2a2a'" onmouseout="this.style.borderColor='#1a1a1a'">
            <input type="checkbox" id="zakatDeduction" style="width:20px;height:20px;cursor:pointer;accent-color:#bef202;" onchange="onZakatToggle()">
            <span style="font-weight:600;color:#ffffff;font-size:14px;flex:1;">Simulate Zakat Deductions</span>
            <span class="info-icon" style="margin-left:0;">i<span class="tooltip">Deducts 2.5% Zakat annually from your projected wealth. Zakat is calculated on the total wealth at the end of each year.</span></span>
        </label>
    </div>

    <!-- LOADER -->
    <div id="loader">
        <div class="spinner"></div>
        <p id="loaderText"></p>
    </div>

    <!-- INFLATION TOGGLE -->
    <div class="inflation-toggle" id="inflationToggleSection">
        <label style="display:flex;align-items:center;gap:0;flex-wrap:wrap;">
            <input type="checkbox" id="inflationAdjusted" style="margin-right:12px;width:20px;height:20px;cursor:pointer;accent-color:#bef202;">
            <span class="inflation-label-text">Show Inflation-Adjusted Numbers</span>
            <span class="info-icon" style="margin-left:8px;">i
                <span class="tooltip">Shows wealth in today's purchasing power. Assumes 10% annual inflation by default ‚Äî you can change this rate below.</span>
            </span>
        </label>
        <div id="inflationRateRow" style="display:none;align-items:center;gap:10px;margin-top:14px;padding-top:14px;border-top:1px solid #222;">
            <span style="font-size:13px;color:#666;">Inflation rate used:</span>
            <input type="number" id="customInflationRate" value="10" step="0.1" inputmode="decimal"
                   style="width:80px;padding:8px 12px;background:#0a0a0a;border:1px solid #2a2a2a;border-radius:8px;color:#bef202;font-size:14px;font-weight:700;"
                   oninput="onInflationRateChange()">
            <span style="font-size:13px;color:#666;">% per year</span>
        </div>
    </div>

    <!-- RESULT CARD -->
    <div class="result-box" id="resultsSection" style="display:none;">
        <h2>Projected Wealth</h2>
        <div class="amount" id="finalWealth">PKR 0</div>
        <p class="years-label" id="yearsLabel">after 20 years</p>
        
        <!-- Custom SIP indicator -->
        <div id="customSipBadge" style="display:none;background:rgba(0,0,0,0.25);border:1.5px solid rgba(0,0,0,0.35);border-radius:8px;padding:8px 14px;margin:0 auto 20px;max-width:fit-content;">
            <span style="font-size:11px;color:#000;font-weight:800;letter-spacing:0.8px;">‚ú¶ USING YOUR CUSTOM SIP SCHEDULE</span>
        </div>

        <!-- Contribution / Profit / Total breakdown -->
        <div class="breakdown-grid" style="margin-bottom:28px;">
            <div class="bk-card" onclick="openBreakdownModal()">
                <div class="bk-icon">üí∞</div>
                <div class="bk-label">Total Invested</div>
                <div class="bk-value" id="totalContrib">PKR 0</div>
                <div class="bk-tap">tap for details</div>
            </div>
            <div class="bk-card" onclick="openBreakdownModal()">
                <div class="bk-icon">üìà</div>
                <div class="bk-label">Total Profit</div>
                <div class="bk-value bk-profit" id="totalProfit">PKR 0</div>
                <div class="bk-tap">tap for details</div>
            </div>
            <div class="bk-card" onclick="openBreakdownModal()">
                <div class="bk-icon">üèÜ</div>
                <div class="bk-label">Total Wealth</div>
                <div class="bk-value" id="totalWealthBreakdown">PKR 0</div>
                <div class="bk-tap">tap for details</div>
            </div>
        </div>

        <div class="passive-info-box">
            <span class="emoji">üí∏</span>
            <div>
                <strong>Passive Income from Your Wealth</strong>
                <p>Estimated income you could generate by deploying your projected wealth into different asset classes. The top row uses your own projected return (<strong id="yourReturnLabel" style="color:#bef202;">12%</strong>) ‚Äî the others show what lower-risk, income-focused strategies would yield. Use Custom ROI to calculate with any rate you choose.</p>
            </div>
        </div>

        <div class="income-header">
            <span class="income-title" id="incomeFrequencyLabel">Monthly Passive Income</span>
            <div class="toggle-buttons">
                <button class="toggle-btn active" id="monthlyBtn" onclick="setIncomeFrequency('monthly')">Monthly</button>
                <button class="toggle-btn"         id="yearlyBtn"  onclick="setIncomeFrequency('yearly')">Yearly</button>
            </div>
        </div>

        <!-- Your Return ‚Äî full width featured card -->
        <div class="income-card income-card-featured">
            <div class="card-label">Your Return (<span id="yourReturnPct">12</span>%)</div>
            <div class="card-value" id="yourReturnIncome">PKR 0</div>
        </div>

        <!-- 2√ó2 lower-risk alternatives -->
        <div class="income-grid">
            <div class="income-card">
                <div class="card-label">Govt Bonds (7%)</div>
                <div class="card-value" id="dividendIncome">PKR 0</div>
            </div>
            <div class="income-card">
                <div class="card-label">Fixed Deposit (8%)</div>
                <div class="card-value" id="fdIncome">PKR 0</div>
            </div>
            <div class="income-card">
                <div class="card-label">Rental Yield (6%)</div>
                <div class="card-value" id="rentalIncome">PKR 0</div>
            </div>
            <div class="income-card">
                <div class="card-label">Gold (9%)</div>
                <div class="card-value" id="goldIncome">PKR 0</div>
            </div>
        </div>

        <div class="custom-roi-row">
            <label class="custom-roi-label">
                <input type="checkbox" id="enableCustomRoi" onchange="toggleCustomRoi()">
                Custom ROI
            </label>
            <div id="customRoiInput" class="hidden">
                <div style="display:flex;align-items:center;gap:10px;margin:10px 0 14px;">
                    <input type="number" id="customRoi" value="8" step="0.1" inputmode="decimal"
                           oninput="updateCustomIncome()"
                           style="width:80px;padding:10px 14px;border-radius:10px;border:1px solid rgba(0,0,0,0.3);background:rgba(0,0,0,0.2);color:#000;font-size:15px;font-weight:700;">
                    <span class="custom-roi-pct">%</span>
                </div>
                <div class="income-card income-card-custom">
                    <div class="card-label">Custom ROI (<span id="customRoiLabel">8</span>%)</div>
                    <div class="card-value" id="customIncome">PKR 0</div>
                </div>
            </div>
        </div>
    </div>

    <!-- CALENDAR YEAR TOGGLE (shown after calculation, below wealth card) -->
    <div id="calendarToggleSection" style="display:none;margin-top:8px;margin-bottom:28px;">
        <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:14px 18px;background:#0f0f0f;border-radius:12px;border:1px solid #1a1a1a;">
            <input type="checkbox" id="useCalendarYears" style="width:18px;height:18px;accent-color:#bef202;cursor:pointer;" onchange="onCalendarToggle()">
            <span style="font-size:14px;font-weight:600;color:#ffffff;">Show Calendar Years</span>
            <span style="font-size:12px;color:#555;margin-left:2px;">(e.g. 2025, 2026‚Ä¶)</span>
        </label>
    </div>

    <!-- CHART -->
    <div class="chart-container" id="chartSection" style="display:none;">
        <canvas id="wealthChart"></canvas>
    </div>

    <!-- FIRE SECTION -->
    <div class="fire-section">
        <div class="checkbox-container">
            <input type="checkbox" id="enableFire" onchange="toggleFireSection()">
            <label for="enableFire">Calculate my FIRE Numbers</label>
        </div>

        <div id="fireInputs" class="fire-inputs hidden">
            <div class="fire-info-box">
                <span class="emoji">üí°</span>
                <div>
                    <strong>What is FIRE?</strong>
                    <p>FIRE (Financial Independence, Retire Early) is achieved when your invested wealth equals <strong style="color:#bef202">25√ó your annual expenses</strong>. This is the globally accepted standard ‚Äî it means your portfolio can sustain your lifestyle indefinitely through investment returns alone.</p>
                </div>
            </div>

            <div class="input-group">
                <label>Current Monthly Expenses (PKR)
                    <span class="info-icon">i<span class="tooltip">Your current monthly living expenses, used to calculate your FIRE number</span></span>
                </label>
                <input type="text" id="monthlyExpenses" placeholder="30,000"
                       inputmode="numeric" oninput="formatNumberInput(this); updateFirePreview();">
            </div>

            <div class="input-group">
                <label>Yearly Expense Increase due to Inflation (%)
                    <span class="info-icon">i<span class="tooltip">Inflation erodes purchasing power every year ‚Äî meaning your expenses will cost more in the future. Your FIRE target rises with it, so the bar keeps moving up.</span></span>
                </label>
                <input type="number" id="expenseIncrease" value="10" step="0.1" inputmode="decimal">
                <small>üí° Defaulting to <strong style="color:#bef202">10%</strong> ‚Äî the average annual inflation rate in Pakistan. Enter 0 if you want to ignore inflation.</small>
            </div>

            <div class="input-group">
                <label>
                    FIRE Multiplier (√ó annual expenses)
                    <span class="info-icon">i<span class="tooltip">How many years of annual expenses should your wealth cover? 25√ó is the globally accepted standard (the "4% rule"). A higher number like 30√ó means a more conservative, secure retirement.</span></span>
                </label>
                <input type="number" id="fireMultiplier" placeholder="25" value="25" min="1" step="1" inputmode="numeric" oninput="updateFirePreview()">
                <small>üí° <strong style="color:#bef202">25√ó is the global FIRE standard.</strong> Choose 30√ó for extra security, or 20√ó for lean FIRE.</small>
            </div>

            <!-- FIRE number preview with toggle -->
            <div id="firePreview" class="fire-preview hidden">
                <div style="display:flex;gap:4px;background:#1a1a1a;padding:4px;border-radius:10px;margin-bottom:14px;border:1px solid #2a2a2a;">
                    <button class="toggle-btn active" id="firePrevTodayBtn" onclick="setFirePreviewMode('today')" style="flex:1;">Today's Number</button>
                    <button class="toggle-btn" id="firePrevInflBtn" onclick="setFirePreviewMode('inflated')" style="flex:1;">At Year N</button>
                </div>
                <span class="fire-preview-label" id="firePreviewLabel">Your FIRE Number (Today)</span>
                <span class="fire-preview-value" id="firePreviewValue">PKR 0</span>
                <span class="fire-preview-sub" id="firePreviewSub">= Monthly Expenses √ó 12 √ó 25</span>
            </div>

            <button class="calc-btn" onclick="calculateFire()">üî• Calculate my FIRE</button>

            <div id="fireResult" class="fire-result hidden"></div>
        </div>
    </div>
</div>

<!-- SIP CELL EDIT POPUP -->
<div class="sip-edit-popup-overlay" id="sipEditPopup" onclick="closeSipEditPopupOutside(event)">
    <div class="sip-edit-popup">
        <h3>Edit SIP Amount</h3>
        <div class="pop-year" id="popYearLabel">Year 1</div>

        <label style="font-size:12px;color:#555;font-weight:600;letter-spacing:0.8px;text-transform:uppercase;display:block;margin-bottom:8px;">Monthly SIP</label>
        <input class="pop-input" type="text" inputmode="numeric" id="popMonthlyInput"
               placeholder="50,000" oninput="onPopMonthlyInput(this)">
        <div class="pop-preview" id="popMonthlyPreview">‚Äî</div>

        <div style="display:flex;align-items:center;gap:10px;margin:16px 0 8px;">
            <div style="flex:1;height:1px;background:#1e1e1e;"></div>
            <span style="font-size:11px;color:#444;font-weight:600;">or enter yearly</span>
            <div style="flex:1;height:1px;background:#1e1e1e;"></div>
        </div>

        <label style="font-size:12px;color:#555;font-weight:600;letter-spacing:0.8px;text-transform:uppercase;display:block;margin-bottom:8px;">Yearly Amount</label>
        <input class="pop-input" type="text" inputmode="numeric" id="popYearlyInput"
               placeholder="600,000" oninput="onPopYearlyInput(this)">
        <div class="pop-preview" id="popYearlyPreview" style="font-size:18px;margin-bottom:20px;">‚Äî</div>

        <div class="sip-edit-popup-btns">
            <button class="pop-cancel" onclick="closeSipEditPopup()">Cancel</button>
            <button class="pop-confirm" onclick="confirmSipEdit()">Update</button>
        </div>
    </div>
</div>
<div class="sip-modal-overlay" id="sipModal" onclick="closeSipModalOutside(event)">
    <div class="sip-modal-box">
        <div class="sip-modal-header">
            <h2>‚úèÔ∏è Your Custom SIP Plan</h2>
            <button class="sip-modal-close" onclick="closeSipModal()">‚úï</button>
        </div>

        <div class="sip-modal-controls">
            <label class="sip-cal-toggle">
                <input type="checkbox" id="modalCalYears" onchange="renderSipTable()">
                Show calendar years
            </label>
            <div style="display:flex;gap:10px;align-items:center;">
                <button class="sip-reset-btn" onclick="resetSipTable()">Reset to auto</button>
                <button class="sip-save-btn" onclick="saveSipEdits()">üíæ Save changes</button>
            </div>
        </div>

        <div class="sip-table-wrap">
            <table class="sip-table" id="sipTable">
                <thead>
                    <tr>
                        <th style="width:30%">Year</th>
                        <th style="width:35%">Monthly SIP</th>
                        <th style="width:35%">Yearly Amount</th>
                    </tr>
                </thead>
                <tbody id="sipTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    /* ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ */
    let chart           = null;
    let lastWealth      = 0;
    let lastTotalContrib= 0;
    let lastYears       = 0;
    let lastLabels      = [];
    let lastWealthData  = [];
    let lastContribData = [];
    let lastFireLine    = null;
    let incomeFrequency = 'monthly';
    const inflationRate = 0.10;

    // SIP schedule: array of {year, monthly, yearly}
    let sipSchedule          = [];
    let sipCustom            = [];   // tracks unsaved edits
    let hasCustomSipSchedule = false;
    let calendarStart        = new Date().getFullYear();

    // Stored after calculateWealth ‚Äî used by FIRE simulation
    let lastSipContribStop = Infinity;  // year after which SIP contributions = 0
    let lastSipRate        = 0;
    let lastSip            = 0;
    let lastSipChange      = 0;
    let lastContribStopAmt = 0;         // cumulative amount threshold (0 = not set)

    /* ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ */
    function parseFormattedNumber(str) {
        return parseFloat((str || '').replace(/,/g, '')) || 0;
    }

    function formatNumberInput(input) {
        const cursorPos = input.selectionStart;
        const oldLen    = input.value.length;
        const digits    = input.value.replace(/\D/g, '');
        if (!digits) { input.value = ''; return; }
        const formatted = parseInt(digits).toLocaleString('en-US');
        input.value = formatted;
        const diff = formatted.length - oldLen;
        try { input.setSelectionRange(cursorPos + diff, cursorPos + diff); } catch(e){}
    }

    function toSuperscript(n) {
        const map = {'0':'‚Å∞','1':'¬π','2':'¬≤','3':'¬≥','4':'‚Å¥','5':'‚Åµ','6':'‚Å∂','7':'‚Å∑','8':'‚Å∏','9':'‚Åπ','-':'‚Åª'};
        return String(n).split('').map(c => map[c] || c).join('');
    }

    function formatCurrency(value) {
        if (!isFinite(value) || isNaN(value)) return 'PKR ‚Äî';
        const v = Math.round(value);
        const abs = Math.abs(v);
        // Scientific notation for absurdly large numbers (> 99,999 Cr = 999 billion)
        if (abs >= 100_000 * 10_000_000) {
            const exp = Math.floor(Math.log10(abs));
            const coeff = (abs / Math.pow(10, exp)).toFixed(2);
            return `PKR ${coeff}√ó10${toSuperscript(exp)}`;
        }
        if (abs >= 10_000_000) return `PKR ${(v / 10_000_000).toFixed(2)} Cr`;
        if (abs >= 100_000)    return `PKR ${(v / 100_000).toFixed(2)} L`;
        return `PKR ${v.toLocaleString('en-US')}`;
    }

    function compactValue(v) {
        if (v >= 10_000_000) return `${(v / 10_000_000).toFixed(0)} Cr`;
        if (v >= 100_000)    return `${(v / 100_000).toFixed(0)} L`;
        if (v >= 1_000)      return `${(v / 1_000).toFixed(0)}K`;
        return `${v}`;
    }

    /* ‚îÄ‚îÄ‚îÄ INCOME DISPLAY ‚îÄ‚îÄ‚îÄ */
    function setIncomeFrequency(freq) {
        incomeFrequency = freq;
        document.getElementById('monthlyBtn').classList.toggle('active', freq === 'monthly');
        document.getElementById('yearlyBtn').classList.toggle('active',  freq === 'yearly');
        document.getElementById('incomeFrequencyLabel').textContent =
            (freq === 'monthly' ? 'Monthly' : 'Yearly') + ' Passive Income';
        updateIncomeDisplay(lastWealth);
    }

    function updateIncomeDisplay(wealth) {
        const mul     = incomeFrequency === 'monthly' ? 1/12 : 1;
        const infl    = document.getElementById('inflationAdjusted').checked;
        const deflate = infl ? Math.pow(1 + getInflationRate(), -lastYears) : 1;
        const w       = wealth * deflate;

        // User's own projected return rate
        const userRate = (parseFloat(document.getElementById('returnRate').value) || 12) / 100;
        const rateEl   = document.getElementById('yourReturnPct');
        const labelEl  = document.getElementById('yourReturnLabel');
        const pct      = Math.round(userRate * 100);
        if (rateEl)   rateEl.textContent   = pct;
        if (labelEl)  labelEl.textContent  = pct + '%';

        document.getElementById('yourReturnIncome').textContent = formatCurrency(w * userRate * mul);
        document.getElementById('fdIncome').textContent         = formatCurrency(w * 0.08 * mul);
        document.getElementById('dividendIncome').textContent   = formatCurrency(w * 0.07 * mul);
        document.getElementById('rentalIncome').textContent     = formatCurrency(w * 0.06 * mul);
        document.getElementById('goldIncome').textContent       = formatCurrency(w * 0.09 * mul);
        updateCustomIncome();
    }

    function toggleCustomRoi() {
        const show = document.getElementById('enableCustomRoi').checked;
        document.getElementById('customRoiInput').classList.toggle('hidden', !show);
        if (show) updateCustomIncome();
    }

    function updateCustomIncome() {
        if (!document.getElementById('enableCustomRoi').checked) return;
        const roi     = parseFloat(document.getElementById('customRoi').value) / 100 || 0;
        const pct     = parseFloat(document.getElementById('customRoi').value) || 8;
        const mul     = incomeFrequency === 'monthly' ? 1/12 : 1;
        const infl    = document.getElementById('inflationAdjusted').checked;
        const deflate = infl ? Math.pow(1 + getInflationRate(), -lastYears) : 1;
        document.getElementById('customIncome').textContent = formatCurrency(lastWealth * roi * mul * deflate);
        const lbl = document.getElementById('customRoiLabel');
        if (lbl) lbl.textContent = pct;
    }

    /* ‚îÄ‚îÄ‚îÄ INFLATION TOGGLE ‚îÄ‚îÄ‚îÄ */
    document.getElementById('inflationAdjusted').addEventListener('change', function() {
        if (!lastWealth) return;
        const on = this.checked;
        // Show/hide custom inflation rate row
        const row = document.getElementById('inflationRateRow');
        row.style.display = on ? 'flex' : 'none';
        refreshDisplayedWealth();
    });

    function getInflationRate() {
        const v = parseFloat(document.getElementById('customInflationRate').value);
        return isNaN(v) ? 0.10 : v / 100;
    }

    function onInflationRateChange() {
        if (!lastWealth) return;
        refreshDisplayedWealth();
    }

    function refreshDisplayedWealth() {
        const infl    = document.getElementById('inflationAdjusted').checked;
        const rate    = getInflationRate();
        const deflate = infl ? Math.pow(1 + rate, -lastYears) : 1;
        const w       = lastWealth * deflate;
        const tc      = lastTotalContrib * deflate;

        document.getElementById('finalWealth').textContent          = formatCurrency(w);
        document.getElementById('totalContrib').textContent         = formatCurrency(tc);
        document.getElementById('totalProfit').textContent          = formatCurrency(w - tc);
        document.getElementById('totalWealthBreakdown').textContent = formatCurrency(w);
        updateIncomeDisplay(lastWealth);
        updateYearsLabel();

        // Rebuild chart with (possibly) inflation-adjusted data
        const cal    = document.getElementById('useCalendarYears').checked;
        const labels = cal ? lastLabels.map(y => `'${String(getCalendarYear(y)).slice(-2)}`) : lastLabels;
        const chartW = infl ? deflateArray(lastWealthData, rate) : lastWealthData;
        const chartC = infl ? deflateArray(lastContribData, rate) : lastContribData;
        const chartF = (infl && lastFireLine) ? deflateArray(lastFireLine, rate) : lastFireLine;
        buildChart(labels, chartW, chartC, chartF);
    }

    function getCalendarYear(y) { return calendarStart + y - 1; }

    function updateYearsLabel() {
        const cal = document.getElementById('useCalendarYears').checked;
        const endYear = cal ? getCalendarYear(lastYears) : null;
        const base = `after ${lastYears} year${lastYears !== 1 ? 's' : ''}`;
        document.getElementById('yearsLabel').textContent = endYear ? `${base} (by ${endYear})` : base;
    }

    function onCalendarToggle() {
        updateYearsLabel();
        // Rebuild chart with calendar labels
        const cal    = document.getElementById('useCalendarYears').checked;
        const labels = cal
            ? lastLabels.map(y => `'${String(getCalendarYear(y)).slice(-2)}`)
            : lastLabels;
        const infl  = document.getElementById('inflationAdjusted').checked;
        const iRate = getInflationRate();
        const wData = infl ? deflateArray(lastWealthData, iRate) : lastWealthData;
        const cData = infl ? deflateArray(lastContribData, iRate) : lastContribData;
        const fData = (infl && lastFireLine) ? deflateArray(lastFireLine, iRate) : lastFireLine;
        buildChart(labels, wData, cData, fData);
        // Also sync modal toggle
        const mCalCheck = document.getElementById('modalCalYears');
        if (mCalCheck) mCalCheck.checked = cal;
    }

    /* ‚îÄ‚îÄ‚îÄ CLEAR ALL ‚îÄ‚îÄ‚îÄ */
    function clearAll() {
        const ids = ['initialInvestment','sip','returnRate','sipYearlyChange','sipStopYear','years',
                     'monthlyExpenses','expenseIncrease','fireMultiplier','sipContribStopYear','sipContribStopAmount'];
        ids.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        // Reset fireMultiplier default
        document.getElementById('fireMultiplier').value = '25';
        document.getElementById('expenseIncrease').value = '10';
        document.getElementById('resultsSection').style.display      = 'none';
        document.getElementById('chartSection').style.display        = 'none';
        document.getElementById('inflationToggleSection').style.display = 'none';
        document.getElementById('sipBreakdownBtn').style.display     = 'none';
        document.getElementById('calendarToggleSection').style.display = 'none';
        document.getElementById('zakatToggleSection').style.display = 'none';
        document.getElementById('fireResult').classList.add('hidden');
        document.getElementById('inflationAdjusted').checked = false;
        document.getElementById('inflationRateRow').style.display = 'none';
        document.getElementById('useCalendarYears').checked = false;
        document.getElementById('customSipBadge').style.display = 'none';
        lastWealth = 0; lastYears = 0; lastTotalContrib = 0;
        lastLabels = []; lastWealthData = []; lastContribData = []; lastFireLine = null;
        lastSipContribStop = Infinity; lastSipRate = 0; lastSip = 0; lastSipChange = 0; lastContribStopAmt = 0;
        sipSchedule = []; sipCustom = []; hasCustomSipSchedule = false;
        if (chart) { chart.destroy(); chart = null; }
    }

    /* ‚îÄ‚îÄ‚îÄ MAIN CALCULATION ‚îÄ‚îÄ‚îÄ */
    function calculateWealth() {
        const initial      = parseFormattedNumber(document.getElementById('initialInvestment').value);
        const sip          = parseFormattedNumber(document.getElementById('sip').value);
        const rate         = parseFloat(document.getElementById('returnRate').value) / 100;
        const scRaw        = document.getElementById('sipYearlyChange').value;
        const sipChange    = scRaw === '' ? 0 : parseFloat(scRaw) / 100;
        const stopYrRaw    = document.getElementById('sipStopYear').value;
        let sipStopYear    = stopYrRaw !== '' ? parseInt(stopYrRaw) : Infinity;
        // If stop mode is "amount", compute equivalent stop year for *increasing*
        if (sipStopMode === 'amount') {
            const stopAmt = parseFormattedNumber(document.getElementById('sipStopAmount').value);
            if (stopAmt > 0 && sip > 0 && sipChange > 0) {
                let tmpSip = sip, tmpY = 1;
                while (tmpSip < stopAmt && tmpY < 1000) { tmpSip *= (1 + sipChange); tmpY++; }
                sipStopYear = tmpY;
            }
        }
        // Resolve the SIP contribution stop year (stops contributing entirely)
        const sipContribStop = getSipContribStopYear(sip, sipChange, sipStopYear);
        const years          = parseInt(document.getElementById('years').value);

        const missing = [];
        if (!rate) missing.push('returnRate');
        if (!years) missing.push('years');

        // Validate stop-increasing-SIP year
        if (sipStopMode === 'year') {
            const stopIncRaw = document.getElementById('sipStopYear').value;
            if (stopIncRaw !== '') {
                const sipIncRaw = document.getElementById('sipYearlyChange').value;
                if (sipIncRaw === '' || parseFloat(sipIncRaw) === 0) {
                    highlightMissing(['sipYearlyChange']);
                    showToast('Enter a Yearly SIP Increase % ‚Äî it\'s required when Stop Increasing SIP is set');
                    return;
                }
                const stopIncVal = parseInt(stopIncRaw);
                if (isNaN(stopIncVal) || stopIncVal < 1 || stopIncVal > years) {
                    highlightMissing(['sipStopYear']);
                    showToast(`Stop increasing SIP year must be between 1 and your investment period (${years} years)`);
                    return;
                }
            }
        }

        // Validate SIP contribution stop year ‚Äî must not exceed investment period
        if (sipContribStopMode === 'year') {
            const contribStopRaw = document.getElementById('sipContribStopYear').value;
            if (contribStopRaw !== '') {
                const contribStopVal = parseInt(contribStopRaw);
                if (isNaN(contribStopVal) || contribStopVal < 1 || contribStopVal > years) {
                    highlightMissing(['sipContribStopYear']);
                    showToast(`SIP stop year must be between 1 and your investment period (${years} years)`);
                    return;
                }
                // Must not be less than stop-increasing year
                if (sipStopMode === 'year') {
                    const stopIncRaw = document.getElementById('sipStopYear').value;
                    if (stopIncRaw !== '') {
                        const stopIncVal = parseInt(stopIncRaw);
                        if (!isNaN(stopIncVal) && contribStopVal < stopIncVal) {
                            highlightMissing(['sipContribStopYear']);
                            showToast(`Stop contributions year can't be less than stop increasing year (${stopIncVal})`);
                            return;
                        }
                    }
                }
            }
        }

        if (missing.length) {
            highlightMissing(missing);
            showToast('Please fill in the highlighted fields to continue');
            return;
        }
        clearHighlights();

        document.getElementById('loader').style.display              = 'block';
        document.getElementById('resultsSection').style.display      = 'none';
        document.getElementById('chartSection').style.display        = 'none';
        document.getElementById('inflationToggleSection').style.display = 'none';
        document.getElementById('sipBreakdownBtn').style.display     = 'none';
        document.getElementById('calendarToggleSection').style.display = 'none';

        const msgs = ['üîÑ Compounding your returns‚Ä¶','üìà Projecting your growth‚Ä¶','üíπ Calculating passive income‚Ä¶','‚úÖ Almost there‚Ä¶'];
        let idx = 0;
        document.getElementById('loaderText').textContent = msgs[0];
        const iv = setInterval(() => {
            idx = (idx + 1) % msgs.length;
            document.getElementById('loaderText').textContent = msgs[idx];
        }, 600);

        setTimeout(() => {
            clearInterval(iv);
            document.getElementById('loader').style.display = 'none';

            const mRate = rate / 12;
            const rawLabels = [], wData = [], cData = [];
            let w = initial, totalC = initial;

            // For amount-mode contrib stop: track cumulative SIP separately
            const contribStopAmt = getSipContribStopAmount();
            let cumSipContrib = 0;  // running total of SIP contributions (excl. initial)

            // Check if we already have a saved custom SIP schedule
            const hasValidSchedule = sipSchedule.length > 0 && sipSchedule.length === years && hasCustomSipSchedule;

            // If no saved schedule OR years changed, rebuild from formula
            if (!hasValidSchedule) {
                sipSchedule = [];
                sipCustom   = [];
                hasCustomSipSchedule = false;
                let curSip = sip;
                let buildCumSip = 0;
                for (let y = 1; y <= years; y++) {
                    let monthlySip;
                    if (y > sipContribStop) {
                        // Year-mode stop: already past stop year
                        monthlySip = 0;
                    } else if (contribStopAmt > 0) {
                        // Amount mode: show the actual monthly contribution for this year
                        const remaining = contribStopAmt - buildCumSip;
                        if (remaining <= 0) {
                            monthlySip = 0;
                        } else {
                            const fullMonthly = Math.round(curSip);
                            const fullYearContrib = fullMonthly * 12;
                            if (fullYearContrib <= remaining) {
                                // Full year fits under the constraint
                                monthlySip = fullMonthly;
                            } else {
                                // Partial year: only some months will contribute
                                // Calculate how many complete months fit, then the remainder
                                // For display: show the effective average monthly = remaining / 12
                                // But for accuracy: show it as the exact partial
                                const fullMonths = Math.floor(remaining / fullMonthly);
                                const leftover   = remaining - fullMonths * fullMonthly;
                                // Store as a special yearly entry: actual yearly = remaining
                                monthlySip = fullMonthly; // monthly rate stays the same
                                // override yearly to show exact remaining
                                buildCumSip += remaining;
                                sipSchedule.push({ year: y, monthly: fullMonthly, yearly: Math.round(remaining) });
                                sipCustom.push(null);
                                if (y < sipStopYear && remaining > 0) curSip *= (1 + sipChange);
                                // Zero out all remaining years
                                for (let ry = y + 1; ry <= years; ry++) {
                                    sipSchedule.push({ year: ry, monthly: 0, yearly: 0 });
                                    sipCustom.push(null);
                                    if (y < sipStopYear) curSip *= (1 + sipChange);
                                }
                                break; // done building schedule
                            }
                        }
                        if (monthlySip !== undefined) buildCumSip += monthlySip * 12;
                    } else {
                        monthlySip = Math.round(curSip);
                    }
                    if (monthlySip === undefined) continue;
                    sipSchedule.push({ year: y, monthly: monthlySip, yearly: monthlySip * 12 });
                    sipCustom.push(null);
                    if (y < sipStopYear && y < sipContribStop && monthlySip > 0) curSip *= (1 + sipChange);
                }
            }

            // Store sipContribStop for use in FIRE simulation
            lastSipContribStop = sipContribStop;
            lastSipRate        = rate;
            lastSip            = sip;
            lastSipChange      = sipChange;
            lastContribStopAmt = contribStopAmt;

            // Now loop and use sipSchedule (which may contain saved custom edits)
            for (let y = 1; y <= years; y++) {
                const data = sipCustom[y - 1] || sipSchedule[y - 1];
                const monthlySip = data.monthly;

                for (let m = 0; m < 12; m++) {
                    // Amount-mode: zero out once cumulative SIP hits the target
                    let actualSip = monthlySip;
                    if (contribStopAmt > 0 && actualSip > 0) {
                        if (cumSipContrib >= contribStopAmt) {
                            actualSip = 0;
                        } else if (cumSipContrib + actualSip > contribStopAmt) {
                            // Partial: only contribute the exact remaining amount
                            actualSip = contribStopAmt - cumSipContrib;
                        }
                    }
                    w = w * (1 + mRate) + actualSip;
                    totalC  += actualSip;
                    cumSipContrib += actualSip;
                }

                // Deduct Zakat (2.5%) at end of each year if enabled
                if (zakatEnabled) w = w * (1 - 0.025);

                rawLabels.push(y);
                wData.push(Math.round(w));
                cData.push(Math.round(totalC));
            }

            lastWealth       = w;
            lastTotalContrib = totalC;
            lastYears        = years;
            lastLabels       = rawLabels;
            lastWealthData   = wData;
            lastContribData  = cData;
            lastFireLine     = null;

            // Apply inflation if toggled
            const infl    = document.getElementById('inflationAdjusted').checked;
            const iRate   = getInflationRate();
            const deflate = infl ? Math.pow(1 + iRate, -years) : 1;
            const dw = w * deflate, dtc = totalC * deflate;

            document.getElementById('finalWealth').textContent          = formatCurrency(dw);
            document.getElementById('totalContrib').textContent         = formatCurrency(dtc);
            document.getElementById('totalProfit').textContent          = formatCurrency(dw - dtc);
            document.getElementById('totalWealthBreakdown').textContent = formatCurrency(dw);

            updateYearsLabel();
            updateIncomeDisplay(w);

            // Show custom SIP badge if saved custom schedule is active
            const customBadge = document.getElementById('customSipBadge');
            if (hasCustomSipSchedule) {
                customBadge.style.display = 'block';
            } else {
                customBadge.style.display = 'none';
            }

            document.getElementById('resultsSection').style.display        = 'block';
            document.getElementById('chartSection').style.display          = 'block';
            document.getElementById('inflationToggleSection').style.display = 'block';
            document.getElementById('sipBreakdownBtn').style.display       = 'block';
            document.getElementById('calendarToggleSection').style.display = 'block';
            document.getElementById('zakatToggleSection').style.display     = 'block';

            // Use calendar labels if toggle is on
            const cal       = document.getElementById('useCalendarYears').checked;
            const labels    = cal ? rawLabels.map(y => `'${String(getCalendarYear(y)).slice(-2)}`) : rawLabels;
            const inflOn    = document.getElementById('inflationAdjusted').checked;
            const iRateNow  = getInflationRate();
            const chartW    = inflOn ? deflateArray(wData, iRateNow) : wData;
            const chartC    = inflOn ? deflateArray(cData, iRateNow) : cData;
            buildChart(labels, chartW, chartC, null);

            // If FIRE was already calculated, prompt user to re-run
            const fireResultEl = document.getElementById('fireResult');
            if (fireResultEl && !fireResultEl.classList.contains('hidden')) {
                fireResultEl.classList.add('hidden');
                setTimeout(() => showFireRerunPrompt(), 300);
            }
        }, 2000);
    }

    /* ‚îÄ‚îÄ‚îÄ CHART ‚îÄ‚îÄ‚îÄ */
    // Deflate a data array by compound inflation: deflatedData[i] = data[i] / (1+rate)^(i+1)
    function deflateArray(arr, rate) {
        return arr.map((v, i) => Math.round(v / Math.pow(1 + rate, i + 1)));
    }

    function buildChart(labels, wealthData, contribData, fireLineData) {
        lastFireLine = fireLineData;
        const ctx = document.getElementById('wealthChart').getContext('2d');
        if (chart) chart.destroy();

        const gW = ctx.createLinearGradient(0, 0, 0, 420);
        gW.addColorStop(0, 'rgba(190,242,2,0.28)');
        gW.addColorStop(1, 'rgba(190,242,2,0.0)');

        const gC = ctx.createLinearGradient(0, 0, 0, 420);
        gC.addColorStop(0, 'rgba(80,200,120,0.18)');
        gC.addColorStop(1, 'rgba(80,200,120,0.0)');

        const datasets = [
            {
                label: 'Your Wealth',
                data: wealthData,
                borderColor: '#bef202',
                borderWidth: 3,
                backgroundColor: gW,
                fill: true,
                tension: 0.42,
                pointRadius: 0,
                pointHoverRadius: 7,
                pointHoverBackgroundColor: '#bef202',
                pointHoverBorderColor: '#000',
                pointHoverBorderWidth: 2,
            },
            {
                label: 'Total Contributions',
                data: contribData,
                borderColor: '#50c878',
                borderWidth: 2,
                backgroundColor: gC,
                fill: true,
                tension: 0.42,
                pointRadius: 0,
                pointHoverRadius: 5,
                pointHoverBackgroundColor: '#50c878',
                pointHoverBorderColor: '#000',
                pointHoverBorderWidth: 2,
            }
        ];

        if (fireLineData && fireLineData.length) {
            datasets.push({
                label: 'FIRE Target',
                data: fireLineData,
                borderColor: '#ff6b6b',
                borderWidth: 2,
                borderDash: [7, 4],
                backgroundColor: 'transparent',
                fill: false,
                tension: 0.3,
                pointRadius: 0,
                pointHoverRadius: 5,
                pointHoverBackgroundColor: '#ff6b6b',
                pointHoverBorderColor: '#000',
                pointHoverBorderWidth: 2,
            });
        }

        const cal = document.getElementById('useCalendarYears').checked;

        chart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 1100, easing: 'easeInOutQuart' },
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: {
                        position: 'top', align: 'end',
                        labels: { color: '#666', font: { size: 12, weight: '600' }, boxWidth: 28, boxHeight: 3, padding: 20 }
                    },
                    tooltip: {
                        backgroundColor: '#111', titleColor: '#fff', bodyColor: '#999',
                        borderColor: '#252525', borderWidth: 1, padding: 16, cornerRadius: 12,
                        callbacks: {
                            title: c => cal ? `${c[0].label}` : `Year ${c[0].label}`,
                            label: c => ` ${c.dataset.label}: ${formatCurrency(c.raw)}`
                        }
                    }
                },
                scales: {
                    x: {
                        title: { display: true, text: cal ? 'Year' : 'Years', color: '#555', font: { size: 12, weight: '600' }, padding: { top: 10 } },
                        grid:  { color: 'rgba(255,255,255,0.04)' },
                        ticks: { color: '#555', font: { size: 11 }, maxTicksLimit: 10 }
                    },
                    y: {
                        title: { display: true, text: 'PKR', color: '#555', font: { size: 12, weight: '700' }, padding: { bottom: 8 } },
                        grid:  { color: 'rgba(255,255,255,0.05)' },
                        ticks: { color: '#555', font: { size: 11 }, maxTicksLimit: 7, callback: v => compactValue(v) }
                    }
                }
            }
        });
    }

    /* ‚îÄ‚îÄ‚îÄ FIRE TOGGLE ‚îÄ‚îÄ‚îÄ */
    function toggleFireSection() {
        document.getElementById('fireInputs').classList.toggle('hidden', !document.getElementById('enableFire').checked);
    }

    /* ‚îÄ‚îÄ‚îÄ FIRE HELPERS ‚îÄ‚îÄ‚îÄ */

    /* Read expense increase: blank ‚Üí 10%, "0" ‚Üí 0 */
    function getExpenseIncrease() {
        const raw = document.getElementById('expenseIncrease').value;
        if (raw === '' || raw === null) return 0.10;
        return parseFloat(raw) / 100;
    }

    /* Read multiplier: blank or invalid ‚Üí 25 */
    function getMultiplier() {
        const raw = document.getElementById('fireMultiplier').value;
        const v   = parseInt(raw);
        return (!raw || isNaN(v) || v < 1) ? 25 : v;
    }

    /*
     * FIRE target for a given year:
     *   = monthlyExpenses √ó 12 √ó (1 + expIncrease)^year √ó multiplier
     *
     * Inflation is applied because if expenses grow each year the wealth needed
     * to cover them (at N√ó annual expenses) also grows ‚Äî the target is a rising line.
     */
    function fireTarget(monthlyExpenses, expIncrease, multiplier, year) {
        return monthlyExpenses * 12 * Math.pow(1 + expIncrease, year) * multiplier;
    }

    /* Live preview ‚Äî updates whenever expenses or multiplier change */
    function updateFirePreview() {
        const expenses   = parseFormattedNumber(document.getElementById('monthlyExpenses').value);
        const multiplier = getMultiplier();
        const preview    = document.getElementById('firePreview');
        if (!expenses) { preview.classList.add('hidden'); return; }
        // Show today's FIRE number (year 0 ‚Äî no inflation yet)
        const fireNum = expenses * 12 * multiplier;
        document.getElementById('firePreviewValue').textContent = formatCurrency(fireNum);
        document.getElementById('firePreviewSub').textContent   = `= Monthly Expenses √ó 12 √ó ${multiplier}`;
        preview.classList.remove('hidden');
    }

    /* ‚îÄ‚îÄ‚îÄ FIRE RE-RUN PROMPT ‚îÄ‚îÄ‚îÄ */
    let fireRerunPending = false;
    function showFireRerunPrompt() {
        if (!document.getElementById('enableFire').checked) return;
        fireRerunPending = true;
        document.getElementById('fireRerunPrompt').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
    function closeFireRerunPrompt(rerun) {
        document.getElementById('fireRerunPrompt').style.display = 'none';
        document.body.style.overflow = '';
        fireRerunPending = false;
        if (rerun) calculateFire();
    }

    /* ‚îÄ‚îÄ‚îÄ FIRE CALCULATION ‚îÄ‚îÄ‚îÄ */
    function calculateFire() {
        const expenses    = parseFormattedNumber(document.getElementById('monthlyExpenses').value);
        const expIncrease = getExpenseIncrease();
        const multiplier  = getMultiplier();
        const investYears = parseInt(document.getElementById('years').value) || 0;

        const fireMissing = [];
        if (!expenses) fireMissing.push('monthlyExpenses');
        if (!investYears) fireMissing.push('years');
        if (!lastWealthData.length) {
            showToast('Please calculate your wealth projection first');
            return;
        }
        if (fireMissing.length) {
            highlightMissing(fireMissing);
            showToast('Please fill in the highlighted fields to continue');
            return;
        }
        clearHighlights();

        const infl  = document.getElementById('inflationAdjusted').checked;
        const iRate = getInflationRate();
        const rate  = parseFloat(document.getElementById('returnRate').value) / 100;
        const mRate = rate / 12;

        // ‚îÄ‚îÄ Warning: if inflation >= return rate, wealth may never outpace FIRE target
        const effectiveCost = expIncrease + (zakatEnabled ? 0.025 : 0);
        const el = document.getElementById('fireResult');
        el.classList.remove('hidden');
        el.style.borderColor = '#ff5f5f';

        if (rate <= expIncrease) {
            el.innerHTML = `
                <div style="text-align:center;padding:8px 0 4px;">
                    <div style="font-size:32px;margin-bottom:12px;">‚ö†Ô∏è</div>
                    <h3 style="color:#ff5f5f;font-size:18px;font-weight:800;margin-bottom:12px;">Inflation Exceeds Your Return Rate</h3>
                    <p style="color:#888;font-size:14px;line-height:1.8;margin-bottom:20px;">
                        Your expense inflation rate (<strong style="color:#ff8c8c">${(expIncrease*100).toFixed(1)}%</strong>) is 
                        equal to or higher than your expected annual return (<strong style="color:#ff8c8c">${(rate*100).toFixed(1)}%</strong>).
                        <br><br>
                        This means your FIRE target grows as fast (or faster) than your wealth ‚Äî you may <strong style="color:#ff8c8c">never reach FIRE</strong> with these numbers.
                        <br><br>
                        Please either increase your <strong style="color:#bef202">Expected Annual Return</strong> above the expense inflation rate, 
                        or reduce the <strong style="color:#bef202">Yearly Expense Increase</strong> in the FIRE section below your return rate.
                    </p>
                    <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
                        <div style="background:#111;border:1px solid #2a2a2a;border-radius:12px;padding:14px 20px;text-align:center;">
                            <div style="font-size:11px;color:#555;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Your Return</div>
                            <div style="font-size:22px;font-weight:900;color:#ff5f5f;">${(rate*100).toFixed(1)}%</div>
                        </div>
                        <div style="display:flex;align-items:center;font-size:20px;color:#555;">‚â§</div>
                        <div style="background:#111;border:1px solid #2a2a2a;border-radius:12px;padding:14px 20px;text-align:center;">
                            <div style="font-size:11px;color:#555;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Expense Inflation</div>
                            <div style="font-size:22px;font-weight:900;color:#ff5f5f;">${(expIncrease*100).toFixed(1)}%</div>
                        </div>
                    </div>
                </div>`;
            return;
        }

        if (zakatEnabled && rate <= effectiveCost) {
            el.innerHTML = `
                <div style="text-align:center;padding:8px 0 4px;">
                    <div style="font-size:32px;margin-bottom:12px;">‚ö†Ô∏è</div>
                    <h3 style="color:#ff5f5f;font-size:18px;font-weight:800;margin-bottom:12px;">Return Too Low with Zakat + Inflation</h3>
                    <p style="color:#888;font-size:14px;line-height:1.8;margin-bottom:20px;">
                        With Zakat deductions (2.5%) and expense inflation (${(expIncrease*100).toFixed(1)}%), 
                        your total annual cost is <strong style="color:#ff8c8c">${(effectiveCost*100).toFixed(1)}%</strong> ‚Äî 
                        which equals or exceeds your return of <strong style="color:#ff8c8c">${(rate*100).toFixed(1)}%</strong>.
                        <br><br>
                        Your wealth may not grow fast enough to ever reach the FIRE target.
                        <br><br>
                        Try increasing your <strong style="color:#bef202">Expected Annual Return</strong> above ${(effectiveCost*100).toFixed(1)}%, 
                        or reducing the <strong style="color:#bef202">Yearly Expense Increase</strong> below ${((rate - 0.025)*100).toFixed(1)}%.
                    </p>
                    <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
                        <div style="background:#111;border:1px solid #2a2a2a;border-radius:12px;padding:14px 20px;text-align:center;">
                            <div style="font-size:11px;color:#555;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Your Return</div>
                            <div style="font-size:22px;font-weight:900;color:#ff5f5f;">${(rate*100).toFixed(1)}%</div>
                        </div>
                        <div style="display:flex;align-items:center;font-size:20px;color:#555;">‚â§</div>
                        <div style="background:#111;border:1px solid #2a2a2a;border-radius:12px;padding:14px 20px;text-align:center;">
                            <div style="font-size:11px;color:#555;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Inflation + Zakat</div>
                            <div style="font-size:22px;font-weight:900;color:#ff5f5f;">${(effectiveCost*100).toFixed(1)}%</div>
                        </div>
                    </div>
                </div>`;
            return;
        }

        // ‚îÄ‚îÄ Step 1: Compare wealth vs FIRE target year-by-year within investment period
        let fireYear         = null;
        let fireWealth       = 0;
        let fireTargetAtYear = 0;
        const fireLineData   = [];

        for (let y = 1; y <= investYears; y++) {
            const target = fireTarget(expenses, expIncrease, multiplier, y);
            const wealth = lastWealthData[y - 1];
            fireLineData.push(Math.round(target));

            if (fireYear === null && wealth >= target) {
                fireYear         = y;
                fireWealth       = wealth;
                fireTargetAtYear = target;
            }
        }

        // Rebuild chart with rising FIRE target line (respect calendar toggle)
        const cal    = document.getElementById('useCalendarYears').checked;
        const labels = cal ? lastLabels.map(y => `'${String(getCalendarYear(y)).slice(-2)}`) : lastLabels;
        const chartW = infl ? deflateArray(lastWealthData, iRate) : lastWealthData;
        const chartC = infl ? deflateArray(lastContribData, iRate) : lastContribData;
        // FIRE target line always shown as nominal (inflation-growing) numbers so the crossing point is visible
        buildChart(labels, chartW, chartC, fireLineData);

        const todayFireNum       = expenses * 12 * multiplier;
        const projectedWealth    = lastWealthData[investYears - 1];
        const inflatedFireTarget = fireTarget(expenses, expIncrease, multiplier, investYears);

        if (fireYear !== null) {
            // FIRE reached within investment period
            const deflate       = infl ? Math.pow(1 + iRate, -fireYear) : 1;
            const displayWealth = fireWealth * deflate;
            const displayTarget = fireTargetAtYear * deflate;
            const displayToday  = infl ? todayFireNum * Math.pow(1 + iRate, 0) : todayFireNum; // today's number never deflated
            el.style.borderColor = '#bef202';
            el.innerHTML = `
                <h3>üî• You can FIRE in</h3>
                <div class="fire-year">${fireYear} Year${fireYear !== 1 ? 's' : ''}</div>
                <p>
                    FIRE multiplier used: <strong style="color:#bef202">${multiplier}√ó</strong>
                    <span style="font-size:12px;color:#666;">(${multiplier === 25 ? 'global standard' : 'custom'})</span><br>
                    Your FIRE Number today: <strong style="color:#bef202">${formatCurrency(todayFireNum)}</strong><br>
                    FIRE target at Year ${fireYear}${infl ? ' <span style="font-size:12px;color:#666;">(in today\'s purchasing power)</span>' : ' (inflation-adjusted)'}: <strong style="color:#bef202">${formatCurrency(infl ? displayTarget : fireTargetAtYear)}</strong><br>
                    Your projected wealth at that point${infl ? ' <span style="font-size:12px;color:#666;">(in today\'s purchasing power)</span>' : ''}: <strong style="color:#bef202">${formatCurrency(infl ? displayWealth : fireWealth)}</strong><br>
                    Your wealth <strong style="color:#bef202">covers ${multiplier} years of inflation-adjusted annual expenses</strong> ‚Äî you're financially free.
                </p>`;
        } else {
            // ‚îÄ‚îÄ FIRE not reached within investment period.
            // Extension simulation: continue year by year beyond the investment period.
            //
            // Rule: if SIP was still running at the END of the investment period
            // (i.e. lastSipContribStop > investYears), continue contributing the final
            // SIP amount each month while simulating. If SIP had already stopped
            // before the end of the investment period, wealth grows on returns only.
            //
            // Zakat (if enabled) is deducted annually in both cases.

            const sipStillRunning = lastSipContribStop > investYears || lastContribStopAmt > 0;

            // Read the "stop increasing SIP" year ‚Äî Infinity if blank
            const scRaw2        = document.getElementById('sipYearlyChange').value;
            const sipChangeExt  = scRaw2 === '' ? 0 : parseFloat(scRaw2) / 100;
            const stopYrRaw2    = document.getElementById('sipStopYear').value;
            let sipStopYearExt  = stopYrRaw2 !== '' ? parseInt(stopYrRaw2) : Infinity;
            if (sipStopMode === 'amount') {
                const stopAmt2 = parseFormattedNumber(document.getElementById('sipStopAmount').value);
                if (stopAmt2 > 0 && lastSip > 0 && sipChangeExt > 0) {
                    let tmp = lastSip, ty = 1;
                    while (tmp < stopAmt2 && ty < 1000) { tmp *= (1 + sipChangeExt); ty++; }
                    sipStopYearExt = ty;
                }
            }

            // Starting SIP for extension: last year's SIP from schedule
            let extCurSip = (sipSchedule.length > 0 ? sipSchedule[investYears - 1].monthly : 0);
            // Track cumulative SIP for amount-mode (includes all contributions already made)
            let extCumSip = lastContribStopAmt > 0 ? lastTotalContrib - (parseFormattedNumber(document.getElementById('initialInvestment').value)) : 0;

            let extFireYear   = null;
            let extFireTarget = 0;
            let extFireWealth = 0;
            let w = lastWealth;
            for (let y = investYears + 1; y <= 100; y++) {
                // Step up SIP for this year if still running and increase not yet frozen
                if (extCurSip > 0 && y - 1 < sipStopYearExt) {
                    extCurSip = Math.round(extCurSip * (1 + sipChangeExt));
                }

                for (let m = 0; m < 12; m++) {
                    let actualSip = extCurSip;
                    // Amount-mode: zero once cumulative hits threshold
                    if (lastContribStopAmt > 0 && actualSip > 0) {
                        if (extCumSip >= lastContribStopAmt) {
                            actualSip = 0;
                        } else if (extCumSip + actualSip > lastContribStopAmt) {
                            actualSip = lastContribStopAmt - extCumSip;
                        }
                    }
                    // Year-mode: zero once past contrib stop year
                    if (lastSipContribStop <= investYears) actualSip = 0;
                    w = w * (1 + mRate) + actualSip;
                    extCumSip += actualSip;
                }
                if (zakatEnabled) w = w * (1 - 0.025);
                const target = fireTarget(expenses, expIncrease, multiplier, y);
                if (w >= target) {
                    extFireYear   = y;
                    extFireTarget = target;
                    extFireWealth = w;
                    break;
                }
            }

            // For suggestion cards ‚Äî compute what's needed to FIRE at the end of the ORIGINAL investment period
            const initial   = parseFormattedNumber(document.getElementById('initialInvestment').value);
            const sip       = parseFormattedNumber(document.getElementById('sip').value);
            const scRaw     = document.getElementById('sipYearlyChange').value;
            const sipChange = scRaw === '' ? 0 : parseFloat(scRaw) / 100;
            const sugg      = computeSuggestions(initial, sip, sipChange, rate, expenses, expIncrease, multiplier, investYears);

            el.innerHTML = buildNotReachedHTML(
                sugg, extFireYear, extFireWealth, investYears,
                todayFireNum, multiplier,
                projectedWealth, inflatedFireTarget,
                extFireTarget, infl, iRate, sipStillRunning
            );
            initCarousel();
        }
    }

    /* ‚îÄ‚îÄ‚îÄ BINARY SEARCH ‚îÄ‚îÄ‚îÄ */
    function bSearch(lo, hi, iters, test) {
        for (let i = 0; i < iters; i++) {
            const mid = (lo + hi) / 2;
            if (test(mid)) hi = mid; else lo = mid;
        }
        return hi;
    }

    function simFinalWealth(init, sip, sipCh, rate, years) {
        const mRate = rate / 12;
        let w = init, cur = sip;
        for (let y = 0; y < years; y++) {
            for (let m = 0; m < 12; m++) w = w * (1 + mRate) + cur;
            cur *= (1 + sipCh);
        }
        return w;
    }

    function computeSuggestions(init, sip, sipCh, rate, monthlyExp, expInc, multiplier, years) {
        // Goal = FIRE target at the END of the investment period (inflation-adjusted)
        const goal = fireTarget(monthlyExp, expInc, multiplier, years);

        const minInit = bSearch(init, Math.max(init * 50 + 1, goal * 3), 48,
            x => simFinalWealth(x, sip, sipCh, rate, years) >= goal);

        const minSip = bSearch(0, Math.max(sip * 100 + 1, goal / 10), 48,
            x => simFinalWealth(init, x, sipCh, rate, years) >= goal);

        const minSipInc = bSearch(0, 3, 48,
            x => simFinalWealth(init, sip, x, rate, years) >= goal);

        /*
         * "Decrease expenses to" ‚Äî find max monthly expenses (today) such that
         * the inflation-adjusted FIRE target at end of period ‚â§ final wealth.
         *
         * fireTarget(maxExp, expInc, multiplier, years) = finalWealth
         * maxExp √ó 12 √ó (1+expInc)^years √ó multiplier = finalWealth
         * maxExp = finalWealth / (12 √ó (1+expInc)^years √ó multiplier)
         *
         * This is a direct calculation ‚Äî no binary search needed.
         */
        const finalWealth  = simFinalWealth(init, sip, sipCh, rate, years);
        const maxMonthlyExp = finalWealth / (12 * Math.pow(1 + expInc, years) * multiplier);

        return { minInit, minSip, minSipInc, maxMonthlyExp };
    }

    function buildNotReachedHTML(s, fireYear, extFireWealth, investYears, todayFireNum, multiplier, projectedWealth, inflatedFireTarget, fireTargetAtActualYear, infl, iRate, sipStillRunning) {
        const extra = fireYear ? fireYear - investYears : null;

        // Apply inflation adjustment to display values when toggle is on
        const deflExt   = (infl && fireYear) ? Math.pow(1 + iRate, -fireYear)   : 1;
        const deflInvest= infl ? Math.pow(1 + iRate, -investYears) : 1;

        // Display numbers ‚Äî nominal unless inflation toggle is on
        const displayProjWealth      = projectedWealth * deflInvest;
        const displayInflatedTarget  = inflatedFireTarget * deflInvest;
        const displayExtWealth       = extFireWealth * deflExt;
        const displayExtTarget       = fireTargetAtActualYear * deflExt;
        const shortfall              = displayInflatedTarget - displayProjWealth;

        const inflNote = infl ? ' <span style="font-size:11px;color:#666;">(today\'s value)</span>' : '';
        const inflNoteTarget = infl ? ' <span style="font-size:11px;color:#666;">(inflation-adjusted)</span>' : '';

        // Gap message depends on whether SIP is still running at end of investment period
        let gapMsg;
        if (!fireYear) {
            gapMsg = `FIRE cannot be reached within 100 years with your current strategy.`;
        } else if (sipStillRunning) {
            // SIP was still active at end of period ‚Äî extension continues SIP contributions
            const sipIncRaw = document.getElementById('sipYearlyChange').value;
            const sipStopRaw = document.getElementById('sipStopYear').value;
            const hasSipIncreaseLimit = sipIncRaw !== '' && parseFloat(sipIncRaw) > 0 && sipStopRaw !== '';
            if (hasSipIncreaseLimit) {
                gapMsg = `With your current strategy, continue investing for <strong style="color:#ff8c8c">${extra} more year${extra !== 1 ? 's' : ''}</strong> beyond your plan (${fireYear} years total) ‚Äî keeping the same SIP ‚Äî to reach the FIRE target of <strong style="color:#ff8c8c">${formatCurrency(displayExtTarget)}</strong>${infl ? ' (in today\'s value)' : ' (inflation-adjusted)'}.`;
            } else {
                gapMsg = `With your current strategy, continue investing for <strong style="color:#ff8c8c">${extra} more year${extra !== 1 ? 's' : ''}</strong> beyond your plan (${fireYear} years total) to reach the FIRE target of <strong style="color:#ff8c8c">${formatCurrency(displayExtTarget)}</strong>${infl ? ' (in today\'s value)' : ' (inflation-adjusted)'}.`;
            }
        } else {
            // SIP stopped before end of period ‚Äî extension is wealth growing on its own
            gapMsg = `After your <strong style="color:#ff8c8c">${investYears}-year</strong> investment period, let your wealth grow on its own for <strong style="color:#ff8c8c">${extra} more year${extra !== 1 ? 's' : ''}</strong> (total ${fireYear} years) to reach the FIRE target of <strong style="color:#ff8c8c">${formatCurrency(displayExtTarget)}</strong>${infl ? ' (in today\'s value)' : ' (inflation-adjusted)'}.`;
        }

        // Suggestion values ‚Äî these are raw lump-sum / SIP numbers (no deflation needed since they are today's inputs)
        return `
        <div class="fire-not-reached-header">
            <h3>‚ö†Ô∏è FIRE Not Reached in ${investYears} Years</h3>
            <p style="margin-top:12px;font-size:14px;color:#888;">${gapMsg}</p>
        </div>

        <div class="fire-stat-stack">
            <div class="fire-stat-row-card">
                <div class="fsr-left">
                    <div class="fsr-label">Your FIRE Number Today</div>
                    <div class="fsr-sub">${multiplier}√ó annual expenses (no inflation)</div>
                </div>
                <div class="fsr-value">${formatCurrency(todayFireNum)}</div>
            </div>
            <div class="fire-stat-row-card fsr-danger">
                <div class="fsr-left">
                    <div class="fsr-label">FIRE Target at Year ${investYears}${inflNote}</div>
                    <div class="fsr-sub">What you'll need after ${investYears} years of expense inflation</div>
                </div>
                <div class="fsr-value" style="color:#ff8c8c;">${formatCurrency(displayInflatedTarget)}</div>
            </div>
            <div class="fire-stat-row-card">
                <div class="fsr-left">
                    <div class="fsr-label">Your Projected Wealth at Year ${investYears}${inflNote}</div>
                    <div class="fsr-sub" style="color:#ff6b6b;">Short by ${formatCurrency(Math.max(0, shortfall))}</div>
                </div>
                <div class="fsr-value">${formatCurrency(displayProjWealth)}</div>
            </div>

        </div>

        <p style="font-size:13px;color:#555;text-align:center;margin-bottom:20px;">Swipe through options below to reach FIRE within your original ${investYears} years üëá</p>

        <div class="suggestions-carousel" id="suggestionsCarousel">

            <div class="suggestion-card">
                <div class="s-number">Option 01</div>
                <div class="s-title">Increase Initial Investment to</div>
                <div class="s-value">${formatCurrency(s.minInit)}</div>
                <div class="s-sub">Contributing ${formatCurrency(s.minInit)} as your opening lump sum ‚Äî with your current monthly SIP and return rate unchanged ‚Äî closes the gap and gets you to FIRE within ${investYears} years.</div>
            </div>

            <div class="suggestion-card">
                <div class="s-number">Option 02</div>
                <div class="s-title">Increase Monthly SIP to</div>
                <div class="s-value">${formatCurrency(s.minSip)}</div>
                <div class="s-sub">Contributing ${formatCurrency(s.minSip)} every month ‚Äî keeping your lump sum and return rate unchanged ‚Äî is sufficient on its own to reach FIRE within ${investYears} years.</div>
            </div>

            <div class="suggestion-card">
                <div class="s-number">Option 03</div>
                <div class="s-title">Grow SIP Annually by</div>
                <div class="s-value">${(s.minSipInc * 100).toFixed(1)}% / yr</div>
                <div class="s-sub">Stepping up your SIP by ${(s.minSipInc * 100).toFixed(1)}% each year ‚Äî with no other changes to your strategy ‚Äî compounds into enough wealth to achieve FIRE within ${investYears} years.</div>
            </div>

            <div class="suggestion-card">
                <div class="s-number">Option 04</div>
                <div class="s-title">Reduce Monthly Expenses to</div>
                <div class="s-value">${formatCurrency(s.maxMonthlyExp)}</div>
                <div class="s-sub">Spending ${formatCurrency(s.maxMonthlyExp)} per month reduces your FIRE target to a level your projected wealth can reach within ${investYears} years ‚Äî no change to your investment strategy required.</div>
            </div>

        </div>

        <div class="carousel-dots" id="carouselDots">
            <div class="carousel-dot active"></div>
            <div class="carousel-dot"></div>
            <div class="carousel-dot"></div>
            <div class="carousel-dot"></div>
        </div>`;
    }

    /* ‚îÄ‚îÄ‚îÄ CAROUSEL DOTS ‚îÄ‚îÄ‚îÄ */
    function initCarousel() {
        setTimeout(() => {
            const carousel = document.getElementById('suggestionsCarousel');
            const dots     = document.querySelectorAll('#carouselDots .carousel-dot');
            if (!carousel || !dots.length) return;

            const cardW = carousel.querySelector('.suggestion-card')?.offsetWidth + 14 || 1;

            carousel.addEventListener('scroll', () => {
                const idx = Math.min(Math.round(carousel.scrollLeft / cardW), dots.length - 1);
                dots.forEach((d, i) => d.classList.toggle('active', i === idx));
            }, { passive: true });
        }, 120);
    }

    /* ‚îÄ‚îÄ‚îÄ SIP MODAL ‚îÄ‚îÄ‚îÄ */

    let popEditIndex = -1;

    function compactSip(v) {
        if (v >= 10_000_000) return `${(v / 10_000_000).toFixed(2)} Cr`;
        if (v >= 100_000)    return `${(v / 100_000).toFixed(2)} L`;
        if (v >= 1_000)      return `${(v / 1_000).toFixed(1)}K`;
        return `${Math.round(v)}`;
    }

    function openSipModal() {
        document.getElementById('modalCalYears').checked =
            document.getElementById('useCalendarYears').checked;
        renderSipTable();
        document.getElementById('sipModal').classList.add('open');
        document.body.style.overflow = 'hidden';
    }

    function closeSipModal() {
        document.getElementById('sipModal').classList.remove('open');
        document.body.style.overflow = '';
        const hasUnsaved = sipCustom.some(x => x !== null);
        const shouldPrompt = hasUnsaved || pendingSimulate;
        pendingSimulate = false;
        if (shouldPrompt) {
            setTimeout(() => {
                document.getElementById('simulatePrompt').style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }, 200);
        }
    }

    function closeSimulatePrompt(simulate) {
        document.getElementById('simulatePrompt').style.display = 'none';
        document.body.style.overflow = '';
        if (simulate) {
            // If user closed without saving, there may still be unsaved edits in sipCustom
            const hasUnsaved = sipCustom.some(x => x !== null);
            if (hasUnsaved) {
                sipSchedule = sipSchedule.map((row, i) =>
                    sipCustom[i] ? { ...row, ...sipCustom[i] } : row
                );
                hasCustomSipSchedule = true;
                sipCustom = sipCustom.map(() => null);
            }
            // sipSchedule already has saved values from saveSipEdits() if user saved
            calculateWealth();
        }
        pendingSimulate = false;
    }

    function closeSipModalOutside(e) {
        if (e.target === document.getElementById('sipModal')) closeSipModal();
    }

    function getYearLabel(y) {
        const useCalendar = document.getElementById('modalCalYears').checked;
        return useCalendar ? (calendarStart + y - 1).toString() : `Year ${y}`;
    }

    function renderSipTable() {
        const tbody = document.getElementById('sipTableBody');
        tbody.innerHTML = '';
        const currentYear = new Date().getFullYear();

        sipSchedule.forEach((row, i) => {
            const data   = sipCustom[i] || row;
            const edited = sipCustom[i] !== null;
            const calYr  = calendarStart + row.year - 1;
            const isNow  = document.getElementById('modalCalYears').checked && calYr === currentYear;

            const tr = document.createElement('tr');
            tr.style.cursor = 'pointer';
            tr.onclick = () => openSipEditPopup(i);
            tr.innerHTML = `
                <td class="year-col ${isNow ? 'current-year' : ''}">${getYearLabel(row.year)}${isNow ? ' ‚Üê' : ''}</td>
                <td>
                    <span style="font-size:16px;font-weight:700;color:${edited ? '#bef202' : '#fff'}">
                        ${compactSip(data.monthly)}
                    </span>
                    ${edited ? `<span class="sip-edited-badge">edited</span>` : ''}
                </td>
                <td>
                    <span style="font-size:14px;font-weight:600;color:#888">
                        ${compactSip(data.yearly)}
                    </span>
                </td>`;
            tbody.appendChild(tr);
        });
    }

    /* ‚îÄ‚îÄ‚îÄ SIP CELL EDIT POPUP ‚îÄ‚îÄ‚îÄ */
    function openSipEditPopup(index) {
        popEditIndex = index;
        const data = sipCustom[index] || sipSchedule[index];
        document.getElementById('popYearLabel').textContent = getYearLabel(sipSchedule[index].year);

        // Populate both fields
        const mInput = document.getElementById('popMonthlyInput');
        const yInput = document.getElementById('popYearlyInput');
        mInput.value = data.monthly.toLocaleString('en-US');
        yInput.value = data.yearly.toLocaleString('en-US');
        document.getElementById('popMonthlyPreview').textContent = compactSip(data.monthly);
        document.getElementById('popYearlyPreview').textContent  = compactSip(data.yearly);

        document.getElementById('sipEditPopup').classList.add('open');
    }

    function closeSipEditPopup() {
        document.getElementById('sipEditPopup').classList.remove('open');
        popEditIndex = -1;
    }

    function closeSipEditPopupOutside(e) {
        if (e.target === document.getElementById('sipEditPopup')) closeSipEditPopup();
    }

    // User edits Monthly ‚Üí auto-calculate Yearly
    function onPopMonthlyInput(input) {
        const raw = input.value.replace(/\D/g, '');
        // Allow empty string while typing; parse as 0 only when raw is non-empty
        const num = raw === '' ? null : parseInt(raw);
        if (num === null) {
            input.value = '';
            document.getElementById('popMonthlyPreview').textContent = '‚Äî';
            document.getElementById('popYearlyInput').value = '';
            document.getElementById('popYearlyPreview').textContent = '‚Äî';
            return;
        }
        input.value = num > 0 ? num.toLocaleString('en-US') : '0';
        document.getElementById('popMonthlyPreview').textContent = compactSip(num) || '0';
        const yearly = num * 12;
        document.getElementById('popYearlyInput').value = yearly > 0 ? yearly.toLocaleString('en-US') : '0';
        document.getElementById('popYearlyPreview').textContent = compactSip(yearly) || '0';
    }

    // User edits Yearly ‚Üí auto-calculate Monthly
    function onPopYearlyInput(input) {
        const raw = input.value.replace(/\D/g, '');
        const num = raw === '' ? null : parseInt(raw);
        if (num === null) {
            input.value = '';
            document.getElementById('popYearlyPreview').textContent = '‚Äî';
            document.getElementById('popMonthlyInput').value = '';
            document.getElementById('popMonthlyPreview').textContent = '‚Äî';
            return;
        }
        input.value = num > 0 ? num.toLocaleString('en-US') : '0';
        document.getElementById('popYearlyPreview').textContent = compactSip(num) || '0';
        const monthly = Math.round(num / 12);
        document.getElementById('popMonthlyInput').value = monthly > 0 ? monthly.toLocaleString('en-US') : '0';
        document.getElementById('popMonthlyPreview').textContent = compactSip(monthly) || '0';
    }

    function confirmSipEdit() {
        if (popEditIndex < 0) return;
        const rawM  = document.getElementById('popMonthlyInput').value.replace(/\D/g, '');
        if (rawM === '') { showToast('Please enter an amount (0 is allowed)'); return; }
        const monthly = parseInt(rawM);

        // If amount exceeds SIP stop limit, show confirmation modal instead of toast
        if (sipStopMode === 'amount') {
            const stopAmt = parseFormattedNumber(document.getElementById('sipStopAmount').value);
            if (stopAmt > 0 && monthly > stopAmt) {
                showSipLimitWarning(monthly, stopAmt);
                return;
            }
        }

        applySipEdit(monthly);
    }

    function applySipEdit(monthly) {
        if (popEditIndex < 0) return;
        if (!sipCustom[popEditIndex]) sipCustom[popEditIndex] = { ...sipSchedule[popEditIndex] };
        sipCustom[popEditIndex].monthly = monthly;
        sipCustom[popEditIndex].yearly  = monthly * 12;
        closeSipEditPopup();
        renderSipTable();
    }

    function showSipAccumWarning(totalCustom, limit) {
        document.getElementById('sipAccumWarnTotal').textContent = formatCurrency(totalCustom);
        document.getElementById('sipAccumWarnLimit').textContent = formatCurrency(limit);
        document.getElementById('sipAccumWarning').style.display = 'flex';
    }

    function closeSipAccumWarning(proceed) {
        document.getElementById('sipAccumWarning').style.display = 'none';
        if (proceed) {
            // Remove the constraint and proceed to save
            lastContribStopAmt = 0;
            // Clear the amount input so it's no longer active
            document.getElementById('sipContribStopAmount').value = '';
            // Now do the actual save
            const hadEdits = sipCustom.some(x => x !== null);
            sipSchedule = sipSchedule.map((row, i) => sipCustom[i] ? { ...row, ...sipCustom[i] } : row);
            if (hadEdits) { hasCustomSipSchedule = true; pendingSimulate = true; }
            sipCustom = sipCustom.map(() => null);
            renderSipTable();
            const btn = document.querySelector('.sip-save-btn');
            if (btn) { const orig = btn.textContent; btn.textContent = '‚úÖ Saved!'; setTimeout(() => btn.textContent = orig, 1500); }
        }
        // If not proceeding, leave edits in sipCustom ‚Äî user can keep editing
    }

    function showSipLimitWarning(monthly, stopAmt) {
        document.getElementById('sipLimitWarnAmt').textContent    = formatCurrency(monthly);
        document.getElementById('sipLimitWarnLimit').textContent  = formatCurrency(stopAmt);
        document.getElementById('sipLimitWarnPending').value      = monthly;
        document.getElementById('sipLimitWarning').style.display  = 'flex';
    }

    function closeSipLimitWarning(confirm) {
        document.getElementById('sipLimitWarning').style.display = 'none';
        if (confirm) {
            const monthly = parseInt(document.getElementById('sipLimitWarnPending').value);
            applySipEdit(monthly);
        }
        // If not confirmed, popup stays open so user can edit the value
    }

    let pendingSimulate = false;  // set true after save, triggers prompt on close

    function saveSipEdits() {
        // If a cumulative SIP constraint is active, check if the total custom schedule exceeds it
        if (lastContribStopAmt > 0) {
            const merged = sipSchedule.map((row, i) => sipCustom[i] ? { ...row, ...sipCustom[i] } : row);
            const totalCustom = merged.reduce((sum, row) => sum + row.yearly, 0);
            if (totalCustom > lastContribStopAmt) {
                showSipAccumWarning(totalCustom, lastContribStopAmt);
                return; // block save until user confirms
            }
        }

        // Merge unsaved edits into sipSchedule
        const hadEdits = sipCustom.some(x => x !== null);
        sipSchedule = sipSchedule.map((row, i) =>
            sipCustom[i] ? { ...row, ...sipCustom[i] } : row
        );
        // Mark as custom BEFORE wiping sipCustom (was the bug: checking after wipe)
        if (hadEdits) {
            hasCustomSipSchedule = true;
            pendingSimulate = true;
        }
        sipCustom = sipCustom.map(() => null);
        renderSipTable();
        const btn = document.querySelector('.sip-save-btn');
        const orig = btn.textContent;
        btn.textContent = '‚úÖ Saved!';
        setTimeout(() => btn.textContent = orig, 1500);
    }

    function resetSipTable() {
        sipCustom = sipCustom.map(() => null);
        hasCustomSipSchedule = false;  // Clear custom flag
        const sip       = parseFormattedNumber(document.getElementById('sip').value);
        const scRaw     = document.getElementById('sipYearlyChange').value;
        const sipChange = scRaw === '' ? 0 : parseFloat(scRaw) / 100;
        const stopYrRaw = document.getElementById('sipStopYear').value;
        const sipStop   = stopYrRaw !== '' ? parseInt(stopYrRaw) : Infinity;
        let cur = sip;
        sipSchedule = sipSchedule.map((row, i) => {
            const monthly = Math.round(cur);
            const entry   = { year: row.year, monthly, yearly: monthly * 12 };
            if (i + 1 < sipStop) cur *= (1 + sipChange);
            return entry;
        });
        renderSipTable();
    }



    /* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
    let toastTimer = null;
    function showToast(msg) {
        const bar = document.getElementById('toastBar');
        bar.textContent = '‚ö†Ô∏è  ' + msg;
        bar.classList.add('show');
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => bar.classList.remove('show'), 3500);
    }

    /* ‚îÄ‚îÄ‚îÄ INPUT HIGHLIGHT ‚îÄ‚îÄ‚îÄ */
    function highlightMissing(ids) {
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            el.classList.add('input-error');
            el.addEventListener('input', () => el.classList.remove('input-error'), { once: true });
        });
    }

    function clearHighlights() {
        document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
    }

    /* ‚îÄ‚îÄ‚îÄ SIP STOP MODE ‚îÄ‚îÄ‚îÄ */
    let sipStopMode = 'year';

    function setSipStopMode(mode) {
        sipStopMode = mode;
        const yearBtn = document.getElementById('sipStopModeYear');
        const amtBtn  = document.getElementById('sipStopModeAmt');
        const yearField = document.getElementById('sipStopYearField');
        const amtField  = document.getElementById('sipStopAmtField');
        yearBtn.classList.toggle('active', mode === 'year');
        amtBtn.classList.toggle('active',  mode === 'amount');
        yearField.style.display = mode === 'year'   ? 'block' : 'none';
        amtField.style.display  = mode === 'amount' ? 'block' : 'none';
    }

    // SIP stop mode initialized via HTML class attributes above

    /* ‚îÄ‚îÄ‚îÄ SIP CONTRIBUTION STOP MODE ‚îÄ‚îÄ‚îÄ */
    let sipContribStopMode = 'year';

    function setSipContribStopMode(mode) {
        sipContribStopMode = mode;
        document.getElementById('sipContribStopModeYear').classList.toggle('active', mode === 'year');
        document.getElementById('sipContribStopModeAmt').classList.toggle('active',  mode === 'amount');
        document.getElementById('sipContribStopYearField').style.display = mode === 'year'   ? 'block' : 'none';
        document.getElementById('sipContribStopAmtField').style.display  = mode === 'amount' ? 'block' : 'none';
    }

    function validateSipStopYear(input) {
        const years = parseInt(document.getElementById('years').value) || 0;
        const val   = parseInt(input.value);
        if (!input.value) { input.classList.remove('input-error'); return; }
        if (isNaN(val) || val < 1) {
            input.classList.add('input-error');
            showToast('Stop increasing SIP year must be at least 1');
            return;
        }
        if (years > 0 && val > years) {
            input.classList.add('input-error');
            showToast(`Stop increasing SIP year cannot exceed your investment period (${years} years)`);
            return;
        }
        input.classList.remove('input-error');
        // Re-validate contrib stop if set, since its floor depends on this value
        const contribInput = document.getElementById('sipContribStopYear');
        if (contribInput && contribInput.value) validateSipContribStopYear(contribInput);
    }

    function validateSipContribStopYear(input) {
        const years = parseInt(document.getElementById('years').value) || 0;
        const val   = parseInt(input.value);
        if (!input.value) { input.classList.remove('input-error'); return; }
        if (isNaN(val) || val < 1) {
            input.classList.add('input-error');
            showToast('SIP stop year must be at least 1');
            return;
        }
        if (years > 0 && val > years) {
            input.classList.add('input-error');
            showToast(`SIP stop year cannot exceed your investment period (${years} years)`);
            return;
        }
        // Must not be less than the "stop increasing SIP" year
        if (sipStopMode === 'year') {
            const stopIncRaw = document.getElementById('sipStopYear').value;
            if (stopIncRaw !== '') {
                const stopInc = parseInt(stopIncRaw);
                if (!isNaN(stopInc) && val < stopInc) {
                    input.classList.add('input-error');
                    showToast(`Stop contributions year (${val}) can't be less than stop increasing year (${stopInc})`);
                    return;
                }
            }
        }
        input.classList.remove('input-error');
    }

    /* Resolve sipContribStopYear from inputs (year mode only).
       Amount mode is handled directly in the calculation loop month-by-month
       so contributions stop the exact month the cumulative total is reached. */
    function getSipContribStopYear(sip, sipChange, sipStopYear) {
        if (sipContribStopMode === 'year') {
            const raw = document.getElementById('sipContribStopYear').value;
            return raw !== '' ? parseInt(raw) : Infinity;
        }
        // Amount mode: return Infinity ‚Äî the loop handles it month by month
        return Infinity;
    }

    /* For amount mode: get the target cumulative amount (0 if not set) */
    function getSipContribStopAmount() {
        if (sipContribStopMode !== 'amount') return 0;
        return parseFormattedNumber(document.getElementById('sipContribStopAmount').value) || 0;
    }


    let zakatEnabled = false;

    function onZakatToggle() {
        zakatEnabled = document.getElementById('zakatDeduction').checked;
        // recalculate with current inputs preserved
        calculateWealth();
    }

    /* Zakat is applied inside the yearly loop ‚Äî 2.5% off wealth at year-end */

    /* ‚îÄ‚îÄ‚îÄ BREAKDOWN MODAL ‚îÄ‚îÄ‚îÄ */
    function openBreakdownModal() {
        if (!lastWealth) return;
        const infl    = document.getElementById('inflationAdjusted').checked;
        const rate    = getInflationRate();
        const deflate = infl ? Math.pow(1 + rate, -lastYears) : 1;
        const w       = lastWealth * deflate;
        const tc      = lastTotalContrib * deflate;
        const profit  = w - tc;
        const contribPct = Math.max(2, Math.round((tc / w) * 100));
        const profitPct  = Math.max(2, Math.round((profit / w) * 100));

        document.getElementById('bkModalContrib').textContent = formatCurrency(tc);
        document.getElementById('bkModalProfit').textContent  = formatCurrency(profit);
        document.getElementById('bkModalWealth').textContent  = formatCurrency(w);
        // Reset bars first
        document.getElementById('bkContribBar').style.width = '0%';
        document.getElementById('bkProfitBar').style.width  = '0%';

        const modal = document.getElementById('breakdownModal');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';

        // Animate bars after render
        requestAnimationFrame(() => {
            setTimeout(() => {
                document.getElementById('bkContribBar').style.width   = contribPct + '%';
                document.getElementById('bkProfitBar').style.width    = profitPct + '%';
                document.getElementById('bkContribPct').textContent   = contribPct + '%';
                document.getElementById('bkProfitPct').textContent    = profitPct + '%';
            }, 60);
        });
    }

    function closeBreakdownModal() {
        document.getElementById('breakdownModal').style.display = 'none';
        document.getElementById('bkContribBar').style.width = '0%';
        document.getElementById('bkProfitBar').style.width  = '0%';
        document.body.style.overflow = '';
    }

    /* ‚îÄ‚îÄ‚îÄ FIRE PREVIEW TOGGLE ‚îÄ‚îÄ‚îÄ */
    let firePreviewMode = 'today';

    function setFirePreviewMode(mode) {
        firePreviewMode = mode;
        document.getElementById('firePrevTodayBtn').classList.toggle('active', mode === 'today');
        document.getElementById('firePrevInflBtn').classList.toggle('active', mode === 'inflated');
        updateFirePreview();
    }

    /* Override updateFirePreview to support both modes */
    const _origUpdateFirePreview = updateFirePreview;
    updateFirePreview = function() {
        const expenses   = parseFormattedNumber(document.getElementById('monthlyExpenses').value);
        const multiplier = getMultiplier();
        const preview    = document.getElementById('firePreview');
        if (!expenses) { preview.classList.add('hidden'); return; }

        const years = parseInt(document.getElementById('years').value) || 20;
        const expInc = getExpenseIncrease();

        if (firePreviewMode === 'today') {
            const fireNum = expenses * 12 * multiplier;
            document.getElementById('firePreviewValue').textContent = formatCurrency(fireNum);
            document.getElementById('firePreviewLabel').textContent = 'Your FIRE Number (Today)';
            document.getElementById('firePreviewSub').textContent   = `= Monthly Expenses √ó 12 √ó ${multiplier}`;
        } else {
            const fireNum = expenses * 12 * Math.pow(1 + expInc, years) * multiplier;
            document.getElementById('firePreviewValue').textContent = formatCurrency(fireNum);
            document.getElementById('firePreviewLabel').textContent = `FIRE Number at Year ${years}`;
            document.getElementById('firePreviewSub').textContent   = `inflation-adjusted at ${Math.round(expInc*100)}% per year`;
        }
        preview.classList.remove('hidden');
    };

    // Sync main calendar toggle with modal
    document.getElementById('useCalendarYears').addEventListener('change', function() {
        const mCalCheck = document.getElementById('modalCalYears');
        if (mCalCheck) mCalCheck.checked = this.checked;
    });
</script>

<!-- BREAKDOWN MODAL -->
<div id="breakdownModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:3000;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(6px);" onclick="if(event.target===this)closeBreakdownModal()">
    <div style="background:#0d0d0d;border:1px solid #222;border-radius:24px;padding:36px;width:100%;max-width:440px;animation:fadeSlideUp 0.3s ease both;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:28px;">
            <h2 style="color:#fff;font-size:20px;font-weight:800;letter-spacing:-0.4px;">Wealth Breakdown</h2>
            <button onclick="closeBreakdownModal()" style="background:#1a1a1a;border:1px solid #2a2a2a;color:#888;width:36px;height:36px;border-radius:50%;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#888'">‚úï</button>
        </div>
        <div style="display:flex;flex-direction:column;gap:16px;">
            <div>
                <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                    <span style="font-size:12px;color:#666;font-weight:600;text-transform:uppercase;letter-spacing:1px;">Total Invested</span>
                    <span style="font-size:14px;font-weight:700;color:#fff;" id="bkModalContrib">PKR 0</span>
                </div>
                <div style="background:#1a1a1a;border-radius:6px;height:8px;overflow:hidden;">
                    <div id="bkContribBar" style="height:100%;background:#50c878;border-radius:6px;transition:width 0.8s ease;width:0%"></div>
                </div>
                <div style="text-align:right;font-size:11px;color:#555;margin-top:4px;" id="bkContribPct">0%</div>
            </div>
            <div>
                <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                    <span style="font-size:12px;color:#666;font-weight:600;text-transform:uppercase;letter-spacing:1px;">Investment Returns</span>
                    <span style="font-size:14px;font-weight:700;color:#bef202;" id="bkModalProfit">PKR 0</span>
                </div>
                <div style="background:#1a1a1a;border-radius:6px;height:8px;overflow:hidden;">
                    <div id="bkProfitBar" style="height:100%;background:#bef202;border-radius:6px;transition:width 0.8s ease;width:0%"></div>
                </div>
                <div style="text-align:right;font-size:11px;color:#555;margin-top:4px;" id="bkProfitPct">0%</div>
            </div>
            <div style="border-top:1px solid #1e1e1e;padding-top:16px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:12px;color:#666;font-weight:600;text-transform:uppercase;letter-spacing:1px;">Total Wealth</span>
                    <span style="font-size:22px;font-weight:900;color:#fff;letter-spacing:-0.8px;" id="bkModalWealth">PKR 0</span>
                </div>
            </div>
        </div>
        <p style="font-size:12px;color:#444;margin-top:24px;text-align:center;line-height:1.6;">Every rupee of profit is money your money made ‚Äî without you lifting a finger.</p>
    </div>
</div>

<!-- SIMULATE PROMPT -->
<div id="simulatePrompt" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:3500;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(8px);">
    <div style="background:#0d0d0d;border:1px solid #2a2a2a;border-radius:24px;padding:36px 32px;width:100%;max-width:400px;animation:fadeSlideUp 0.3s ease both;text-align:center;">
        <div style="font-size:40px;margin-bottom:16px;">üìã</div>
        <h3 style="color:#fff;font-size:18px;font-weight:800;margin-bottom:12px;letter-spacing:-0.3px;">Simulate with Custom SIP?</h3>
        <p style="color:#666;font-size:14px;line-height:1.7;margin-bottom:28px;">You've made changes to your SIP schedule. Run the wealth projection with your custom SIP plan?</p>
        <div style="display:flex;gap:12px;">
            <button onclick="closeSimulatePrompt(false)" style="flex:1;padding:15px;background:#1a1a1a;border:1px solid #2a2a2a;border-radius:12px;color:#888;font-size:14px;font-weight:600;cursor:pointer;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#888'">Keep as is</button>
            <button onclick="closeSimulatePrompt(true)" style="flex:1;padding:15px;background:linear-gradient(135deg,#bef202,#a0d000);border:none;border-radius:12px;color:#000;font-size:14px;font-weight:800;cursor:pointer;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='none'">Simulate Now</button>
        </div>
    </div>
</div>

<!-- FIRE RE-RUN PROMPT -->
<div id="fireRerunPrompt" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:3500;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(8px);">
    <div style="background:#0d0d0d;border:1px solid #2a2a2a;border-radius:24px;padding:36px 32px;width:100%;max-width:400px;animation:fadeSlideUp 0.3s ease both;text-align:center;">
        <div style="font-size:40px;margin-bottom:16px;">üî•</div>
        <h3 style="color:#fff;font-size:18px;font-weight:800;margin-bottom:12px;letter-spacing:-0.3px;">Projected Wealth Changed</h3>
        <p style="color:#666;font-size:14px;line-height:1.7;margin-bottom:28px;">Your wealth projection has been updated. Recalculate your FIRE numbers to reflect the new projection?</p>
        <div style="display:flex;gap:12px;">
            <button onclick="closeFireRerunPrompt(false)" style="flex:1;padding:15px;background:#1a1a1a;border:1px solid #2a2a2a;border-radius:12px;color:#888;font-size:14px;font-weight:600;cursor:pointer;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#888'">Keep old result</button>
            <button onclick="closeFireRerunPrompt(true)" style="flex:1;padding:15px;background:linear-gradient(135deg,#bef202,#a0d000);border:none;border-radius:12px;color:#000;font-size:14px;font-weight:800;cursor:pointer;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='none'">Recalculate FIRE</button>
        </div>
    </div>
</div>

<!-- SIP LIMIT WARNING -->
<input type="hidden" id="sipLimitWarnPending" value="0">
<div id="sipAccumWarning" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:4000;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(8px);">
    <div style="background:#0d0d0d;border:1px solid #ff5f5f;border-radius:24px;padding:36px 32px;width:100%;max-width:420px;animation:fadeSlideUp 0.3s ease both;text-align:center;">
        <div style="font-size:40px;margin-bottom:16px;">‚ö†Ô∏è</div>
        <h3 style="color:#ff5f5f;font-size:18px;font-weight:800;margin-bottom:12px;letter-spacing:-0.3px;">Exceeds SIP Accumulation Limit</h3>
        <p style="color:#888;font-size:14px;line-height:1.7;margin-bottom:8px;">
            Your custom SIP schedule totals <strong style="color:#fff" id="sipAccumWarnTotal"></strong>, which exceeds your accumulation constraint of <strong style="color:#fff" id="sipAccumWarnLimit"></strong>.
        </p>
        <p style="color:#666;font-size:13px;line-height:1.6;margin-bottom:28px;">If you continue, the SIP accumulation constraint will be <strong style="color:#ff8c8c">removed</strong>. Or go back and adjust your schedule.</p>
        <div style="display:flex;gap:12px;">
            <button onclick="closeSipAccumWarning(false)" style="flex:1;padding:15px;background:#1a1a1a;border:1px solid #2a2a2a;border-radius:12px;color:#888;font-size:14px;font-weight:600;cursor:pointer;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#888'">Go Back</button>
            <button onclick="closeSipAccumWarning(true)" style="flex:1;padding:15px;background:#ff5f5f;border:none;border-radius:12px;color:#fff;font-size:14px;font-weight:800;cursor:pointer;" onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">Remove Constraint & Save</button>
        </div>
    </div>
</div>

<input type="hidden" id="sipLimitWarnPending" value="0">
<div id="sipLimitWarning" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:4000;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(8px);">
    <div style="background:#0d0d0d;border:1px solid #ff5f5f;border-radius:24px;padding:36px 32px;width:100%;max-width:400px;animation:fadeSlideUp 0.3s ease both;text-align:center;">
        <div style="font-size:40px;margin-bottom:16px;">‚ö†Ô∏è</div>
        <h3 style="color:#ff5f5f;font-size:18px;font-weight:800;margin-bottom:12px;letter-spacing:-0.3px;">Exceeds SIP Limit</h3>
        <p style="color:#888;font-size:14px;line-height:1.7;margin-bottom:8px;">
            The amount you entered (<strong style="color:#fff" id="sipLimitWarnAmt"></strong>) exceeds your SIP stop limit of <strong style="color:#fff" id="sipLimitWarnLimit"></strong>.
        </p>
        <p style="color:#666;font-size:13px;line-height:1.6;margin-bottom:28px;">Do you want to save it anyway, or go back and edit the amount?</p>
        <div style="display:flex;gap:12px;">
            <button onclick="closeSipLimitWarning(false)" style="flex:1;padding:15px;background:#1a1a1a;border:1px solid #2a2a2a;border-radius:12px;color:#888;font-size:14px;font-weight:600;cursor:pointer;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#888'">Edit Amount</button>
            <button onclick="closeSipLimitWarning(true)" style="flex:1;padding:15px;background:#ff5f5f;border:none;border-radius:12px;color:#fff;font-size:14px;font-weight:800;cursor:pointer;" onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">Save Anyway</button>
        </div>
    </div>
</div>

<div id="toastBar"></div>
</body>
</html>
